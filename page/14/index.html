<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>一条肥鱼</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="一条肥鱼"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="一条肥鱼"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="一条肥鱼"><meta property="og:url" content="https://feiyu.dev/"><meta property="og:site_name" content="一条肥鱼"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://feiyu.dev/img/og_image.png"><meta property="article:author" content="一条肥鱼"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://feiyu.dev"},"headline":"一条肥鱼","image":["https://feiyu.dev/img/og_image.png"],"author":{"@type":"Person","name":"一条肥鱼"},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="一条肥鱼" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Docker">Docker</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/feiyudev"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-26T02:44:37.000Z" title="2019-03-26T02:44:37.000Z">2019-03-26</time>发表</span><span class="level-item"><time dateTime="2022-04-20T16:29:18.405Z" title="2022-04-20T16:29:18.405Z">2022-04-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Spring%E7%B3%BB%E5%88%97/">Spring系列</a></span><span class="level-item">3 分钟读完 (大约521个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/26/0dc6f9376a15.html">SpringBoot启动的Tomcat不接收特殊字符而报400Bad Request错误</a></h1><div class="content">现象GET请求中输入*[ ] ^ ` { | }*符号，服务器报400错误</div><a class="article-more button is-small is-size-7" href="/2019/03/26/0dc6f9376a15.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-26T02:00:51.000Z" title="2019-03-26T02:00:51.000Z">2019-03-26</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:01.990Z" title="2021-02-09T03:03:01.990Z">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">8 分钟读完 (大约1180个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/26/945fdb518121.html">解决使用MyBatis处理含有$的变量时报IllegalArgumentException Illegal group reference</a></h1><div class="content"><h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>在一个GET请求中，输入参数包含$符号，然后后台报错。</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://localhost:9999/xxxx/drivers?page=1&amp;size=20&amp;realname=$&#x27; \</span><br><span class="line">-H &#x27;Accept-Encoding: gzip, deflate&#x27; \</span><br><span class="line">-H &#x27;Accept-Language: zh,en;q=0.9,ja;q=0.8,zh-TW;q=0.7,fr;q=0.6,zh-CN;q=0.5&#x27; \</span><br><span class="line">-H &#x27;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36&#x27; \</span><br><span class="line">-H &#x27;Accept: application/json, text/plain, */*&#x27; \</span><br><span class="line">-H &#x27;userId: 453&#x27; \</span><br><span class="line">-H &#x27;Connection: keep-alive&#x27; \</span><br><span class="line">-H &#x27;token: 1e6966ec2fafdbbd53ef53124cc3e5ae&#x27; \</span><br><span class="line">--compressed</span><br></pre></td></tr></table></figure>

<h2 id="报错截图"><a href="#报错截图" class="headerlink" title="报错截图"></a>报错截图</h2><p><img src="/images/pics/820618bc0b05edc0c53b018552fd191f.png" alt="在这里插入图片描述"></p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>这个现象与mybatis无关，因为mybatis对$符号的操作主要集中在<code>GenericTokenParser.java</code>中，而这些操作都是以<code>\$&#123;</code>出现，因此可以认为mybatis不处理单独的<code>$</code>符号。如下：<br><img src="/images/pics/0f729d0c03b4812345637b862b991a4b.png" alt="在这里插入图片描述"><br>在interceptor中，有一段打印将要执行的sql语句相关信息，根据调试结果，锁定了这个方法出问题所在，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object obj = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, getParameterValue(obj));</span><br></pre></td></tr></table></figure>

<p>因此问题转化成了下面的问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有问题的语句</span></span><br><span class="line">String sql = <span class="string">&quot;er WHERE realname like ? AND deleted = ?&quot;</span>;</span><br><span class="line">sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, <span class="string">&quot;\\%$%&quot;</span>);</span><br><span class="line">System.out.println(sql);</span><br><span class="line"><span class="comment">// 修改</span></span><br><span class="line">sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(<span class="string">&quot;\\%$%&quot;</span>));</span><br></pre></td></tr></table></figure>
<h2 id="在replaceFirst-String-regex-String-replacement-中的使用"><a href="#在replaceFirst-String-regex-String-replacement-中的使用" class="headerlink" title="$在replaceFirst(String regex, String replacement)中的使用"></a>$在<code>replaceFirst(String regex, String replacement)</code>中的使用</h2><p>网上关于这个方法的使用，普遍停留在regex，对replacement的解释少之又少，基本上没有。因为$符号在replacement中导致操作报错，因此，这个$肯定是有某种特殊的意义的。打开源代码，一直跟踪到抛出错误的地方。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Processes replacement string to replace group references with</span></span><br><span class="line"><span class="comment"> * groups.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> StringBuilder <span class="title">appendExpandedReplacement</span><span class="params">(String replacement, StringBuilder result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cursor = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (cursor &lt; replacement.length()) &#123;</span><br><span class="line">        <span class="keyword">char</span> nextChar = replacement.charAt(cursor);</span><br><span class="line">        <span class="comment">// 可以看出，转义符号使用起来也需要小心。如果在最后面，又会报错。</span></span><br><span class="line">        <span class="keyword">if</span> (nextChar == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">            cursor++;</span><br><span class="line">            <span class="keyword">if</span> (cursor == replacement.length())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">&quot;character to be escaped is missing&quot;</span>);</span><br><span class="line">            <span class="comment">// 对转义符的操作比较简单，只是先跳过转义符，然后将下一个字符拷贝</span></span><br><span class="line">            nextChar = replacement.charAt(cursor);</span><br><span class="line">            result.append(nextChar);</span><br><span class="line">            cursor++;</span><br><span class="line">        <span class="comment">// 如果是$，那么后面要么是数字，要么是&#123;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextChar == <span class="string">&#x27;$&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// Skip past $</span></span><br><span class="line">            cursor++;</span><br><span class="line">            <span class="comment">// Throw IAE if this &quot;$&quot; is the last character in replacement</span></span><br><span class="line">            <span class="keyword">if</span> (cursor == replacement.length())</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">&quot;Illegal group reference: group index is missing&quot;</span>);</span><br><span class="line">            nextChar = replacement.charAt(cursor);</span><br><span class="line">            <span class="keyword">int</span> refNum = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (nextChar == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                cursor++;</span><br><span class="line">                StringBuilder gsb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="comment">// 先读出&#123;&#125;中的内容</span></span><br><span class="line">                <span class="keyword">while</span> (cursor &lt; replacement.length()) &#123;</span><br><span class="line">                    nextChar = replacement.charAt(cursor);</span><br><span class="line">                    <span class="keyword">if</span> (ASCII.isLower(nextChar) ||</span><br><span class="line">                        ASCII.isUpper(nextChar) ||</span><br><span class="line">                        ASCII.isDigit(nextChar)) &#123;</span><br><span class="line">                        gsb.append(nextChar);</span><br><span class="line">                        cursor++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (gsb.length() == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;named capturing group has 0 length name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (nextChar != <span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;named capturing group is missing trailing &#x27;&#125;&#x27;&quot;</span>);</span><br><span class="line">                String gname = gsb.toString();</span><br><span class="line">                <span class="keyword">if</span> (ASCII.isDigit(gname.charAt(<span class="number">0</span>)))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;capturing group name &#123;&quot;</span> + gname +</span><br><span class="line">                        <span class="string">&quot;&#125; starts with digit character&quot;</span>);</span><br><span class="line">                <span class="comment">//&#123;&#125;中包含的内容，是分组的名字，分组存在，直接拿来分组的值，不存在则报错</span></span><br><span class="line">                <span class="keyword">if</span> (!parentPattern.namedGroups().containsKey(gname))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;No group with name &#123;&quot;</span> + gname + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">                refNum = parentPattern.namedGroups().get(gname);</span><br><span class="line">                cursor++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The first number is always a group</span></span><br><span class="line">                refNum = nextChar - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                <span class="comment">// 只接受0-9的数字，也就是分组的序号</span></span><br><span class="line">                <span class="keyword">if</span> ((refNum &lt; <span class="number">0</span>) || (refNum &gt; <span class="number">9</span>))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;Illegal group reference&quot;</span>);</span><br><span class="line">                cursor++;</span><br><span class="line">                <span class="comment">// Capture the largest legal group string</span></span><br><span class="line">                <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cursor &gt;= replacement.length()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">int</span> nextDigit = replacement.charAt(cursor) - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                    <span class="keyword">if</span> ((nextDigit &lt; <span class="number">0</span>) || (nextDigit &gt; <span class="number">9</span>)) &#123; <span class="comment">// not a number</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">int</span> newRefNum = (refNum * <span class="number">10</span>) + nextDigit;</span><br><span class="line">                    <span class="keyword">if</span> (groupCount() &lt; newRefNum) &#123;</span><br><span class="line">                        done = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        refNum = newRefNum;</span><br><span class="line">                        cursor++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Append group</span></span><br><span class="line">            <span class="keyword">if</span> (start(refNum) != -<span class="number">1</span> &amp;&amp; end(refNum) != -<span class="number">1</span>)</span><br><span class="line">                result.append(text, start(refNum), end(refNum));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.append(nextChar);</span><br><span class="line">            cursor++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，<strong>转义符号使用起来也需要小心。如果在最后面，又会报错，对转义符的操作比较简单，只是先跳过转义符，然后将下一个字符拷贝；如果是<code>$</code>，那么后面要么是<code>数字</code>，要么是<code>&#123;</code>。对$符号的处理，如果后面是<code>&#123;</code>，则先读出<code>&#123;&#125;</code>中的内容，也就是分组的名字，然后查询分组是否存在，存在则直接拿来分组的值，不存在则报错，如果后面是数字，就去拿第n个分组的值。</strong></p>
<p>过程如上，但是网上基本上没有上述内容的示例，根据上面的简要分析，做出了下面简要的demo：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String Str = <span class="keyword">new</span> String(<span class="string">&quot;Welcome to Tutoririalspoint.combb&quot;</span>);</span><br><span class="line">System.out.print(<span class="string">&quot;Return Value :&quot;</span> );</span><br><span class="line">System.out.println(Str.replaceFirst(<span class="string">&quot;Tuto(.*)als(?&lt;hi&gt;.*)(bb)&quot;</span>, <span class="string">&quot;$1AMROOD&#125;$2--$3--$&#123;hi&#125;--xx&quot;</span>));</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// Return Value :Welcome to ririAMROOD&#125;point.com--bb--point.com--xx</span></span><br></pre></td></tr></table></figure>
<p>给分组命名确实以前没尝试过，参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/415580/regex-named-groups-in-java%E3%80%82">https://stackoverflow.com/questions/415580/regex-named-groups-in-java。</a></p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>替换后的方法如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">showSql</span><span class="params">(Configuration configuration, BoundSql boundSql)</span> </span>&#123;</span><br><span class="line">  Object parameterObject = boundSql.getParameterObject();</span><br><span class="line">  List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">  String sql = boundSql.getSql().replaceAll(<span class="string">&quot;[\\s]+&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (parameterMappings.size() &gt; <span class="number">0</span> &amp;&amp; parameterObject != <span class="keyword">null</span>) &#123;</span><br><span class="line">    TypeHandlerRegistry typeHandlerRegistry = configuration.getTypeHandlerRegistry();</span><br><span class="line">    <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">      sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(getParameterValue(parameterObject)));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      MetaObject metaObject = configuration.newMetaObject(parameterObject);</span><br><span class="line">      <span class="keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">        String propertyName = parameterMapping.getProperty();</span><br><span class="line">        <span class="keyword">if</span> (metaObject.hasGetter(propertyName)) &#123;</span><br><span class="line">          Object obj = metaObject.getValue(propertyName);</span><br><span class="line">          sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(getParameterValue(obj)));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">          Object obj = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">          sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(getParameterValue(obj)));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：<br><a target="_blank" rel="noopener" href="https://github.com/abel533/Mapper/issues/30">https://github.com/abel533/Mapper/issues/30</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-22T22:44:49.000Z" title="2019-03-22T22:44:49.000Z">2019-03-23</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:29.007Z" title="2021-02-09T03:03:29.007Z">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">16 分钟读完 (大约2329个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/23/14909257ac39.html">MyBatis分页插件PageHelper封装以及遇到的bug</a></h1><div class="content"><p>PageHelper链接：<a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper">https://github.com/pagehelper/Mybatis-PageHelper</a><br>项目中使用到了一个注解，叫做<code>PageAble</code>，这是一个对<code>PageHelper</code>的封装注解。这个注解有一个非常显著的问题就是，<strong>不能在这个方法里面执行两次SQL查询</strong>（原因将在后续中慢慢分析）。使用方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PageAble</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">method</span><span class="params">(<span class="keyword">int</span> page, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">	。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解的内容比较简单，就是定义了两个参数，分别为这两个参数设置了默认的名字、以及默认值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PageAble &#123;</span><br><span class="line">	 <span class="function">String <span class="title">pageSizeName</span><span class="params">()</span> <span class="keyword">default</span> &quot;size&quot;</span>;</span><br><span class="line">	 <span class="function">String <span class="title">pageNumName</span><span class="params">()</span> <span class="keyword">default</span> &quot;page&quot;</span>;</span><br><span class="line">	 <span class="function"><span class="keyword">int</span> <span class="title">pageSize</span><span class="params">()</span> <span class="keyword">default</span> 20</span>;</span><br><span class="line">	 <span class="function"><span class="keyword">int</span> <span class="title">pageNum</span><span class="params">()</span> <span class="keyword">default</span> 1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后得到的返回值是一个叫做<code>ResultPageView</code>的类，是对分页情况的一个封装，其中的内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultPageView</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	 <span class="keyword">private</span> Long total = <span class="number">0l</span>;</span><br><span class="line">	 <span class="keyword">private</span> Integer current = <span class="number">1</span>;</span><br><span class="line">	 <span class="keyword">private</span> Integer pageCount = <span class="number">0</span>;</span><br><span class="line">	 <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line">	 <span class="comment">// 省略一些构造方法、getter/setter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，最重要的问题当然是<strong>被<code>@PageAble</code>注解的方法是怎样执行的</strong>。显然这里是利用了Spring AOP，在这个方法的前后，加上了自定义的处理方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PAGE_ABLE = <span class="string">&quot;@annotation(com.xxxxxo0o0.baseservice.annotation.PageAble)&quot;</span>;</span><br><span class="line"><span class="meta">@Around(PAGE_ABLE)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">doAroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">	logger.info(<span class="string">&quot;execute method : &quot;</span> + proceedingJoinPoint.getSignature().getName());</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 准备开始分页</span></span><br><span class="line">		prepare(proceedingJoinPoint);</span><br><span class="line">		<span class="comment">// 执行被注解的方法</span></span><br><span class="line">		Object obj = proceedingJoinPoint.proceed();</span><br><span class="line">		<span class="comment">// 装饰被注解方法返回的值</span></span><br><span class="line">		Object result = after(obj);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">		logger.error(<span class="string">&quot;aspect execute error : &quot;</span>, throwable);</span><br><span class="line">		<span class="keyword">throw</span> throwable;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="comment">// 先忽略这个finally里面的内容</span></span><br><span class="line">		<span class="comment">//PageHelper.clearPage();</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在被注解方法执行前的准备活动中，执行了什么操作？代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	Signature signature = point.getSignature();</span><br><span class="line">	MethodSignature methodSignature = (MethodSignature) signature;</span><br><span class="line">	Method targetMethod = methodSignature.getMethod();</span><br><span class="line">	PageAble pageAble = targetMethod.getAnnotation(PageAble.class);</span><br><span class="line">	<span class="comment">// 获取参数名称</span></span><br><span class="line">	String numName = pageAble.pageNumName();</span><br><span class="line">	String sizeName = pageAble.pageSizeName();</span><br><span class="line">	<span class="comment">// 先获取page和size的默认值</span></span><br><span class="line">	<span class="keyword">int</span> pageNo = pageAble.pageNum();</span><br><span class="line">	<span class="keyword">int</span> pageSize = pageAble.pageSize();</span><br><span class="line">	<span class="comment">// 获取参数值列表</span></span><br><span class="line">	Object[] paramValues = point.getArgs();</span><br><span class="line">	<span class="comment">// 获取参数名列表</span></span><br><span class="line">	String[] paramNames = methodSignature.getParameterNames();</span><br><span class="line">	<span class="keyword">int</span> length = paramNames.length;</span><br><span class="line">	<span class="comment">// 对参数列表进行遍历</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">		<span class="comment">// 如果参数名 == 注解中写入的页数参数名</span></span><br><span class="line">		<span class="keyword">if</span> (paramNames[i].equals(numName)) &#123;</span><br><span class="line">			<span class="comment">// 从参数值列表中取出值，赋值给页数</span></span><br><span class="line">			pageNo = (Integer) paramValues[i];</span><br><span class="line">		<span class="comment">// 如果参数名 == 注解中写入的每页数量的参数名</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramNames[i].equals(sizeName)) &#123;</span><br><span class="line">			<span class="comment">// // 从参数值列表中取出值，赋值为每页尺寸</span></span><br><span class="line">			pageSize = (Integer) paramValues[i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 调用PageHelper的分页</span></span><br><span class="line">	PageHelper.startPage(pageNo, pageSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先忽略其中的细节，看看被注解方法后面执行的方法做了什么事情，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">after</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> obj <span class="keyword">instanceof</span> List;</span><br><span class="line">    PageInfo&lt;?&gt; pageInfo = <span class="keyword">new</span> PageInfo((List&lt;?&gt;) obj);</span><br><span class="line">    <span class="comment">// 从某个地方获取的分页的信息。（其实是ThreadLocal，先忽略）</span></span><br><span class="line">    Page&lt;Object&gt; localPage = PageHelper.getLocalPage();</span><br><span class="line">    <span class="comment">// 获取分页参数</span></span><br><span class="line">    <span class="keyword">long</span> total = localPage.getTotal();</span><br><span class="line">    <span class="keyword">int</span> pageNum = localPage.getPageNum();</span><br><span class="line">    <span class="keyword">int</span> pages = localPage.getPages();</span><br><span class="line">    List&lt;?&gt; list = (List&lt;?&gt;) obj;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	    List&lt;Map&gt; mapList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	    <span class="keyword">for</span> (Object o : list) &#123;</span><br><span class="line">	    	<span class="comment">// 将一个对象按照原来的字段名转成map</span></span><br><span class="line">			HashMap&lt;String, Object&gt; map = MapUtil.convertObj2Map(o);</span><br><span class="line">			<span class="keyword">if</span> (o <span class="keyword">instanceof</span> BaseModel) &#123;</span><br><span class="line">				BaseModel baseModel = (BaseModel) o;</span><br><span class="line">				map.put(<span class="string">&quot;id&quot;</span>, baseModel.getId());</span><br><span class="line">			&#125;</span><br><span class="line">			ReflectionUtils</span><br><span class="line">			    .doWithFields(o.getClass(), <span class="keyword">new</span> InnerFieldCallback(map, o), <span class="keyword">new</span> InnerFieldFilter());</span><br><span class="line">			mapList.add(map);</span><br><span class="line">	    &#125;</span><br><span class="line">	    list = mapList;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		logger.error(<span class="string">&quot;convert obj to map occurred error &quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    pageInfo = <span class="keyword">new</span> PageInfo((list));</span><br><span class="line">    ResultPageView&lt;?&gt; resultPageView;</span><br><span class="line">    resultPageView = <span class="keyword">new</span> ResultPageView&lt;&gt;(total, pageNum, pages, pageInfo.getList());</span><br><span class="line">    <span class="comment">// 清除分页信息</span></span><br><span class="line">    PageHelper.clearPage();</span><br><span class="line">    <span class="keyword">return</span> resultPageView;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="PageHelper-start-做了什么"><a href="#PageHelper-start-做了什么" class="headerlink" title="PageHelper.start()做了什么"></a>PageHelper.start()做了什么</h2><p>一路往父类翻到start()的实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开始分页</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageNum      页码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSize     每页显示数量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> count        是否进行count查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> reasonable   分页合理化,null时用默认配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSizeZero true且pageSize=0时返回全部结果，false时分页,null时用默认配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; <span class="function">Page&lt;E&gt; <span class="title">startPage</span><span class="params">(<span class="keyword">int</span> pageNum, <span class="keyword">int</span> pageSize, <span class="keyword">boolean</span> count, Boolean reasonable, Boolean pageSizeZero)</span> </span>&#123;</span><br><span class="line">    Page&lt;E&gt; page = <span class="keyword">new</span> Page&lt;E&gt;(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    <span class="comment">//当已经执行过orderBy的时候</span></span><br><span class="line">    Page&lt;E&gt; oldPage = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (oldPage != <span class="keyword">null</span> &amp;&amp; oldPage.isOrderByOnly()) &#123;</span><br><span class="line">        page.setOrderBy(oldPage.getOrderBy());</span><br><span class="line">    &#125;</span><br><span class="line">    setLocalPage(page);</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>setLocalPage()</code>与之前的<code>after()</code>中的<code>getLocalPage()</code>是一对get/set方法，他们的目的是从当前线程中获取/设置分页信息。其实现如下（关于ThreadLocal的具体实现，可以去参考其他博客）:<br><img src="/images/pics/b62b0868d8f630c716947cd56e737676.png" alt="在这里插入图片描述"><br>既然<code>startPage()</code>只是在线程中塞了一个关于分页的信息，那么真正读取这个分页信息的动作一定是在处理SQL语句的地方，也就是<code>Interceptor</code>。PageHelper的官方使用文档链接：<br><a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/HowToUse.md">https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/HowToUse.md</a><br>其中也有一块，是对不安全分页的说明：</p>
<blockquote>
<p><code>PageHelper</code> 方法使用了静态的 <code>ThreadLocal</code> 参数，分页参数和线程是绑定的。只要你可以保证在 <code>PageHelper</code> 方法调用后紧跟 MyBatis 查询方法，这就是安全的。因为 <code>PageHelper</code> 在 <code>finally</code> 代码段中自动清除了 <code>ThreadLocal</code> 存储的对象。如果代码在进入 <code>Executor</code> 前发生异常，就会导致线程不可用，这属于人为的 Bug（例如接口方法和 XML 中的不匹配，导致找不到 <code>MappedStatement</code> 时），这种情况由于线程不可用，也不会导致 <code>ThreadLocal</code> 参数被错误的使用。但是如果你写出下面这样的代码，就是不安全的用法：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">List&lt;Country&gt; list;</span><br><span class="line"><span class="keyword">if</span>(param1 != <span class="keyword">null</span>)&#123;</span><br><span class="line">    list = countryMapper.selectIf(param1);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = <span class="keyword">new</span> ArrayList&lt;Country&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这种情况下由于 param1 存在 null 的情况，就会导致 PageHelper 生产了一个分页参数，但是没有被消费，这个参数就会一直保留在这个线程上。当这个线程再次被使用时，就可能导致不该分页的方法去消费这个分页参数，这就产生了莫名其妙的分页。</p>
</blockquote>
<p>因此打开项目中的<code>MyPageInterceptor</code>，它的功能就是充当Mybatis的拦截器，还有一部分自定义的功能，比如说输出sql执行时间、打印sql语句。这个类与PageHelper的拦截器关键的代码基本一致，可以说是copy吧，其中关键的一个地方是<code>intercept()</code>方法中，有一个进行判断，是否需要分页的语句。<br><img src="/images/pics/59c3c19ef68fc581e6b02027a6a6f3a1.png" alt="在这里插入图片描述"><br>在查询完毕后，finally方法回执行一次清除动作：<br><img src="/images/pics/b31da2dfa6341acab5451c18e0e88645.png" alt="在这里插入图片描述"><br>这个dialect是一个本地的类，继承自PageHelper这个类，覆盖了其中的afterAll()方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPageHelper</span> <span class="keyword">extends</span> <span class="title">PageHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 获取分页信息</span></span><br><span class="line">		Page&lt;Object&gt; localPage = getLocalPage();</span><br><span class="line">		<span class="comment">// 调用父类方法，即清除分页信息</span></span><br><span class="line">		<span class="keyword">super</span>.afterAll();</span><br><span class="line">		<span class="comment">// 又将分页信息塞回线程中。</span></span><br><span class="line">		<span class="comment">// 为什么要这样做？为了让在切面中，加入分页的详细信息。</span></span><br><span class="line">		setLocalPage(localPage);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的代码执行完成后，不论查询的结果是成功还是失败，分页信息都会存在当前线程中（如果直接调用父类的方法，不自定义这个方法，就能保证执行完一次查询，分页信息不会保存在当前线程中）。问题就出在这里。因为<code>interceptor</code>处理过后，当前线程中还存在分页的信息，并且这个分页的信息需要以来切面的处理方法来完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">skip</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ms.getId().endsWith(MSUtils.COUNT))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;在系统中发现了多个分页插件，请检查系统配置!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Page page = pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//设置默认的 count 列</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtil.isEmpty(page.getCountColumn()))&#123;</span><br><span class="line">            page.setCountColumn(pageParams.getCountColumn());</span><br><span class="line">        &#125;</span><br><span class="line">        autoDialect.initDelegateDialect(ms);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中获取Page的代码是这样的，说到底还是从当前线程中去取：<br><img src="/images/pics/64df87d52a0c862bddb99638c1dced69.png" alt="在这里插入图片描述"></p>
<h2 id="bug描述与分析"><a href="#bug描述与分析" class="headerlink" title="bug描述与分析"></a>bug描述与分析</h2><p><strong>执行一个分页查询，让查询故意报错，多执行几次，然后再进行一次普通查询，得到ClassCastException异常。</strong><br>因此，问题已经出来了。<br><img src="/images/pics/1ee8292005525f274ca585166dfe6f0b.png" alt="在这里插入图片描述"></p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>因此加上finally后，无论是否报错，那么分页信息都将会被在线程中清除。问题就解决了，所以把涂掉的finally加上清除分页信息的处理，即可解决此问题。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>批量发送请求的脚本，用来引发bug用：<br><strong>main.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">host1 = <span class="string">&#x27;localhost:9999&#x27;</span></span><br><span class="line">host2 = <span class="string">&#x27;xxxxxxxx&#x27;</span></span><br><span class="line">host = host1</span><br><span class="line">MAX = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vehicle</span>():</span></span><br><span class="line">    parse_response(send_get_req(<span class="string">&#x27;http://&#x27;</span>+host+<span class="string">&#x27;/nemt/driver/get&#x27;</span>))</span><br><span class="line">    parse_response(send_get_req(<span class="string">&#x27;http://&#x27;</span>+host+<span class="string">&#x27;/nemt/vehicles?page=1&amp;size=20&#x27;</span>))</span><br><span class="line">    parse_response(send_get_req(<span class="string">&#x27;http://&#x27;</span>+host+<span class="string">&#x27;/nemt/vehicleType/all&#x27;</span>))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app_version</span>():</span></span><br><span class="line">    parse_response(send_get_req(<span class="string">&#x27;http://&#x27;</span>+host+<span class="string">&#x27;/nemt/driver-apps&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_response</span>(<span class="params">resp</span>):</span></span><br><span class="line">    s = json.loads(resp[<span class="number">0</span>].content)</span><br><span class="line">    <span class="keyword">if</span> s[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">        <span class="comment"># print()</span></span><br><span class="line">        print(<span class="string">&quot;x &quot;</span> + s[<span class="string">&#x27;message&#x27;</span>] + <span class="string">&#x27; --&gt; &#x27;</span> + resp[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;o&quot;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_get_req</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="comment"># print(&#x27;url --&gt; &#x27;+url)</span></span><br><span class="line">    <span class="keyword">return</span> requests.get(url), url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt;= MAX:</span><br><span class="line">        app_version()</span><br><span class="line">        vehicle()</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p><strong>crack.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/env bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [<span class="variable">$1</span> -eq <span class="string">&quot;&quot;</span>]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    max=1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    max=<span class="variable">$1</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">fi</span></span></span><br><span class="line">for i in $(seq 1 $1):</span><br><span class="line">do</span><br><span class="line">curl &#x27;http://localhost:9999/nemt/orders?page=1&amp;size=20&#x27; -H &#x27;Accept-Encoding: gzip, deflate&#x27; -H &#x27;Accept-Language: zh,en;q=0.9,ja;q=0.8,zh-TW;q=0.7,fr;q=0.6,zh-CN;q=0.5&#x27; -H &#x27;User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36&#x27; -H &#x27;Accept: application/json, text/plain, */*&#x27; -H &#x27;userId: 453&#x27; -H &#x27;Connection: keep-alive&#x27; -H &#x27;token: 48143d9154e7c42face53855826f5ffa&#x27; --compressed</span><br><span class="line">echo &#x27;&#x27;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-22T05:37:36.000Z" title="2019-03-22T05:37:36.000Z">2019-03-22</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:48.571Z" title="2021-02-09T03:03:48.571Z">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></span><span class="level-item">2 分钟读完 (大约363个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/22/2a22ce9bac07.html">curl设置header和表单数据</a></h1><div class="content"><blockquote>
<p>老是分不清楚header和表单时的写法，每次都去翻别人的博客</p>
</blockquote>
<h2 id="从浏览器中获取某个请求的curl版本"><a href="#从浏览器中获取某个请求的curl版本" class="headerlink" title="从浏览器中获取某个请求的curl版本"></a>从浏览器中获取某个请求的curl版本</h2><p><img src="/images/pics/e4f0a7a5665593a55874780d2e0a64e9.png" alt="在这里插入图片描述"><br>下面是几种上述方法拷贝出来的curl命令参数，特意列出来，供参考一下。</p>
<h2 id="设置header与表单"><a href="#设置header与表单" class="headerlink" title="设置header与表单"></a>设置header与表单</h2><p>GET请求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://xxxxxxxxx/vehicles?page=1&amp;size=20&amp;number=8&#x27; \</span><br><span class="line">-H &#x27;Accept-Encoding: gzip, deflate&#x27; \</span><br><span class="line">-H &#x27;Accept-Language: zh,en;q=0.9,ja;q=0.8,zh-TW;q=0.7,fr;q=0.6,zh-CN;q=0.5&#x27; \</span><br><span class="line">-H &#x27;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36&#x27; \</span><br><span class="line">-H &#x27;Accept: application/json, text/plain, */*&#x27; \</span><br><span class="line">-H &#x27;Referer: http://xxxxxxxxx/&#x27; \</span><br><span class="line">-H &#x27;userId: 454&#x27; \</span><br><span class="line">-H &#x27;Connection: keep-alive&#x27; \</span><br><span class="line">-H &#x27;token: af0d8773933eaeffc81d97924bd2a8fc&#x27; \</span><br><span class="line">--compressed</span><br></pre></td></tr></table></figure>
<p>POST请求，<strong>发送body信息</strong><br><code>--data-binary DATA  HTTP POST binary data (H)</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://xxxxxxxxx/nemt/nemt/order/cancel&#x27; </span><br><span class="line">-H &#x27;Origin: http://xxxxxxxxx&#x27; </span><br><span class="line">-H &#x27;Accept-Encoding: gzip, deflate&#x27; </span><br><span class="line">-H &#x27;Accept-Language: zh,en;q=0.9,ja;q=0.8,zh-TW;q=0.7,fr;q=0.6,zh-CN;q=0.5&#x27; </span><br><span class="line">-H &#x27;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36&#x27; </span><br><span class="line">-H &#x27;Content-Type: application/json&#x27; </span><br><span class="line">-H &#x27;Accept: application/json, text/plain, */*&#x27; </span><br><span class="line">-H &#x27;Referer: http://xxxxxxxxx/&#x27; </span><br><span class="line">-H &#x27;userId: 454&#x27; </span><br><span class="line">-H &#x27;Connection: keep-alive&#x27; </span><br><span class="line">-H &#x27;token: af0d8773933eaeffc81d97924bd2a8fc&#x27; </span><br><span class="line">--data-binary &#x27;&#123;&quot;id&quot;:&quot;10076&quot;,&quot;reasonId&quot;:0&#125;&#x27; </span><br><span class="line">--compressed</span><br></pre></td></tr></table></figure>
<p>POST请求，<strong>发送表单</strong><br><code>--data DATA     HTTP POST data (H)</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 此例来自：http://www.ruanyifeng.com/blog/2011/09/curl.html</span></span><br><span class="line">curl -X POST --data &quot;data=xxx&quot; example.com/form.cgi</span><br></pre></td></tr></table></figure>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 此例来自项目中某安卓端代码</span></span><br><span class="line">do_upload()&#123;</span><br><span class="line">    curl -X POST -F &quot;file=@$1&quot; $2</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此例来自：http://www.ruanyifeng.com/blog/2011/09/curl.html</span></span><br><span class="line">curl --form upload=@localfilename --form press=OK [URL]</span><br></pre></td></tr></table></figure>

<p>OK，清理书签完毕！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-22T05:13:11.000Z" title="2019-03-22T05:13:11.000Z">2019-03-22</time>发表</span><span class="level-item"><time dateTime="2022-04-20T16:46:51.815Z" title="2022-04-20T16:46:51.815Z">2022-04-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a></span><span class="level-item">9 分钟读完 (大约1341个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/22/22c744900f73.html">Linux中的特殊符号以及特殊语法</a></h1><div class="content">辨别||、&amp;&amp;、;、$*等符号在linux中的含义与或# 将&amp;&amp;前后的两个命令当做一个表达式，如果表达式出错，那么可以认为该表达式为false➜  ~ ls / &amp;&amp; datebin  boot  dev  etc  home  initrd.img </div><a class="article-more button is-small is-size-7" href="/2019/03/22/22c744900f73.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-20T00:38:33.000Z" title="2019-03-20T00:38:33.000Z">2019-03-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:52.714Z" title="2021-02-09T03:03:52.714Z">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span> / </span><a class="link-muted" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span><span class="level-item">5 分钟读完 (大约785个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/20/5156767b418e.html">解决web端登录时等待过久并偶尔抛出事务相关异常</a></h1><div class="content"><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><img src="/images/pics/b121bd559df52a004b45e06e2cc88495.png" alt="在这里插入图片描述"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>登录函数中有一个事务，如下：<br><img src="/images/pics/0608cdfe9b3f587c7bcf75a95a61f312.png" alt="在这里插入图片描述"><br>事务里面有一个有可能操作比较耗时的过程：<br><img src="/images/pics/c48cc071a374cc675606da7556e12130.png" alt="在这里插入图片描述"><br>在新增登录日志的时候，获取用户的ip。<br><img src="/images/pics/7eb2aaf28af964507dc55b2cb69d18a2.png" alt="在这里插入图片描述"><br>具体干了啥不重要，重要的是发了一个http请求，并且是串行的，所以这个请求比较耗时的可能是很大的，并且具备不确定性因素。<br><img src="/images/pics/30bb080b6e51b36241ad15dcc01c8ef4.png" alt="在这里插入图片描述"></p>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p><code>TransactionRollbackException</code>的文档注释为：</p>
<p><em>This exception indicates that the transaction associated with processing of the request has been rolled back, or marked to roll back. Thus the requested operation either could not be performed or was not performed because further computation on behalf of the transaction would be fruitless</em></p>
<p>可能的过程为：线程1进入事务、然后进行了一次update操作，获得了一个排他锁，然后被卡在了获取ip的那个地方，即此事务持有着排他锁，然后还长时间不结束（50s+），然后线程2也进入了事务，此时在进行update的时候，需要等待线程1释放排它锁，在50秒过后，仍未获取到锁，此时获取锁时间超过了预设，抛出上述异常。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>规避潜在的耗时操作。<strong>但是由于此服务没人维护，因此通过本地编译，然后拉包替换相应class文件，再上传到服务器的方式进行修改。</strong></p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>查看获取锁的超时阀值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%timeout%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----------------------------+----------+</span></span><br><span class="line">| Variable_name               | Value    |</span><br><span class="line">+<span class="comment">-----------------------------+----------+</span></span><br><span class="line">| connect_timeout             | 10       |</span><br><span class="line">| delayed_insert_timeout      | 300      |</span><br><span class="line">| have_statement_timeout      | YES      |</span><br><span class="line">| innodb_flush_log_at_timeout | 1        |</span><br><span class="line">| innodb_lock_wait_timeout    | 50       |</span><br><span class="line">| innodb_rollback_on_timeout  | OFF      |</span><br><span class="line">| interactive_timeout         | 28800    |</span><br><span class="line">| lock_wait_timeout           | 31536000 |</span><br><span class="line">| net_read_timeout            | 30       |</span><br><span class="line">| net_write_timeout           | 60       |</span><br><span class="line">| rpl_stop_slave_timeout      | 31536000 |</span><br><span class="line">| slave_net_timeout           | 60       |</span><br><span class="line">| wait_timeout                | 28800    |</span><br><span class="line">+<span class="comment">-----------------------------+----------+</span></span><br><span class="line">13 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------------------------Controller------------</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测试web端登录锁表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/hotline/test&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSomeThing</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    testService.doSomething();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ----------------------------Service----------------</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> BizConfMapper confMapper;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 共享锁</span></span><br><span class="line">    BizConf conf = confMapper.selectByPrimaryKey(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 排它锁</span></span><br><span class="line">    confMapper.updateByPrimaryKey(conf);</span><br><span class="line">    <span class="comment">// 等待让下个线程超时，最起码要大于50</span></span><br><span class="line">    Thread.sleep(<span class="number">60000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>日志输出与项目中出现的错误信息基本一致，如下：<br><img src="/images/pics/3be7b45fa1d895fd19656ba7b1a932cd.png" alt="在这里插入图片描述"><br>在<code>@Transactional</code>注解中加入timeout后，报错不一样，但是阔以理解为spring框架为我们抛出了异常。如下：<br><img src="/images/pics/1cfe80e7355ec2e1ff68cb468b0c96bb.png" alt="在这里插入图片描述"></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>其中对我理解这种现象有很大帮助的资料为这一张图，它让我明白了锁与事务之间的关系。<br><img src="/images/pics/9bebe9ada738c3908c5baa7df6041ae8.png" alt="在这里插入图片描述"><br>参考：<br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014133576">https://segmentfault.com/a/1190000014133576</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-19T22:55:56.000Z" title="2019-03-19T22:55:56.000Z">2019-03-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:24.643Z" title="2021-02-09T03:03:24.643Z">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></span><span class="level-item">8 分钟读完 (大约1212个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/20/67f245149110.html">【转载-摘要】彻底搞懂 Git-Rebase</a></h1><div class="content"><p>原文链接：<a target="_blank" rel="noopener" href="http://jartto.wang/2018/12/11/git-rebase/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io">http://jartto.wang/2018/12/11/git-rebase/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</a></p>
<blockquote>
<p>rebase的主要功能就是改变commit历史，在这篇文章中，场景一是改变未push的commit历史，场景二是在合并分支时，改变当前分支的历史，从而达到简化commit历史的目的，让历史一目了然。对强迫症患者来说简直就是福音。</p>
</blockquote>
<h2 id="Rebase-场景一：如何合并多次提交纪录？"><a href="#Rebase-场景一：如何合并多次提交纪录？" class="headerlink" title="Rebase 场景一：如何合并多次提交纪录？"></a>Rebase 场景一：如何合并多次提交纪录？</h2><p>1.我们来合并最近的 4 次提交纪录，执行：<br><code>git rebase -i HEAD~4</code><br>2.这时候，会自动进入 vi 编辑模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">s cacc52da add: qrcode</span><br><span class="line">s f072ef48 update: indexeddb hack</span><br><span class="line">s 4e84901a feat: add indexedDB floder</span><br><span class="line">s 8f33126c feat: add test2.js</span><br><span class="line"># Rebase 5f2452b2..8f33126c onto 5f2452b2 (4 commands)</span><br><span class="line">#</span><br><span class="line"># Commands:</span><br><span class="line"># p, pick &#x3D; use commit</span><br><span class="line"># r, reword &#x3D; use commit, but edit the commit message</span><br><span class="line"># e, edit &#x3D; use commit, but stop for amending</span><br><span class="line"># s, squash &#x3D; use commit, but meld into previous commit</span><br><span class="line"># f, fixup &#x3D; like &quot;squash&quot;, but discard this commit&#39;s log message</span><br><span class="line"># x, exec &#x3D; run command (the rest of the line) using shell</span><br><span class="line"># d, drop &#x3D; remove commit</span><br><span class="line">#</span><br><span class="line"># These lines can be re-ordered; they are executed from top to bottom.</span><br><span class="line">#</span><br><span class="line"># If you remove a line here THAT COMMIT WILL BE LOST.</span><br><span class="line">#</span><br><span class="line"># However, if you remove everything, the rebase will be aborted.</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>有几个命令需要注意一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p, pick &#x3D; use commit</span><br><span class="line">r, reword &#x3D; use commit, but edit the commit message</span><br><span class="line">e, edit &#x3D; use commit, but stop for amending</span><br><span class="line">s, squash &#x3D; use commit, but meld into previous commit</span><br><span class="line">f, fixup &#x3D; like “squash”, but discard this commit’s log message</span><br><span class="line">x, exec &#x3D; run command (the rest of the line) using shell</span><br><span class="line">d, drop &#x3D; remove commit</span><br></pre></td></tr></table></figure>
<p>按照如上命令来修改你的提交纪录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s cacc52da add: qrcode</span><br><span class="line">s f072ef48 update: indexeddb hack</span><br><span class="line">s 4e84901a feat: add indexedDB floder</span><br><span class="line">p 8f33126c feat: add test2.js</span><br></pre></td></tr></table></figure>
<p>3.如果保存的时候，你碰到了这个错误：<br><code>error: cannot &#39;squash&#39; without a previous commit</code><br>注意不要合并先前提交的东西，也就是已经提交远程分支的纪录。</p>
<p>4.如果你异常退出了 vi 窗口，不要紧张：</p>
<p><code>git rebase --edit-todo</code><br>这时候会一直处在这个编辑的模式里，我们可以回去继续编辑，修改完保存一下：</p>
<p><code>git rebase --continue</code><br>5.查看结果</p>
<p><code>git log</code><br><img src="/images/pics/fb33ecfed184aa1e8eb0ff37342d2365.png" alt="在这里插入图片描述"><br>三次提交合并成了一次，减少了无用的提交信息。</p>
<h2 id="Rebase-场景二：分支合并"><a href="#Rebase-场景二：分支合并" class="headerlink" title="Rebase 场景二：分支合并"></a>Rebase 场景二：分支合并</h2><p>1.我们先从 <code>master</code> 分支切出一个 <code>dev</code> 分支，进行开发：</p>
<p><code>git:(master) git checkout -b feature1</code><img src="/images/pics/34ab1852ac35e18f3cff7d1a6a957445.png" alt="git1"><br>2.这时候，你的同事完成了一次 <code>hotfix</code>，并合并入了 <code>master</code> 分支，此时 <code>master</code> 已经领先于你的 <code>feature1</code> 分支了：<br><img src="/images/pics/80e9026f136aa5977c154f591e4c9f06.png" alt="git2"><br>3.恰巧，我们想要同步 master 分支的改动，首先想到了 merge，执行：</p>
<p><code>git:(feature1) git merge master</code><br><img src="/images/pics/8ad11677746f10dc8b13a62048fc47e0.png" alt="git3"><br>图中绿色的点就是我们合并之后的结果，执行：</p>
<p><code>git:(feature1) git log</code><br>就会在记录里发现一些 merge 的信息，但是我们觉得这样污染了 commit 记录，想要保持一份干净的 commit，怎么办呢？这时候，git rebase 就派上用场了。</p>
<p>4.让我们来试试 git rebase ，先回退到同事 hotfix 后合并 master 的步骤：<br><img src="/images/pics/1453ae33d7a5325ab8334ae4e1583987.png" alt="git4"><br>5.使用 <code>rebase</code> 后来看看结果：</p>
<p><code>git:(feature1) git rebase master</code><br>这里补充一点：<code>rebase</code> 做了什么操作呢？</p>
<p>首先，git 会把 <code>feature1</code> 分支里面的每个 <code>commit</code> 取消掉；<br>其次，把上面的操作临时保存成 <code>patch</code> 文件，存在 <code>.git/rebase</code> 目录下；<br>然后，把 <code>feature1</code> 分支更新到最新的 <code>master</code> 分支；<br>最后，把上面保存的 <code>patch</code> 文件应用到 <code>feature1</code> 分支上；<br><img src="/images/pics/14e012b09e59970e733b4c6681bf0279.png" alt="git5"><br>从 <code>commit</code> 记录我们可以看出来，<code>feature1</code> 分支是基于 <code>hotfix</code> 合并后的 <code>master</code> ，自然而然的成为了最领先的分支，而且没有 <code>merge</code> 的 <code>commit</code> 记录，是不是感觉很舒服了。</p>
<p>6.在 <code>rebase</code> 的过程中，也许会出现冲突 conflict。在这种情况，git 会停止 <code>rebase</code> 并会让你去解决冲突。在解决完冲突后，用 <code>git add</code> 命令去更新这些内容。</p>
<p>注意，你无需执行 <code>git-commit</code>，只要执行 continue</p>
<p><code>git rebase --continue</code><br>这样 git 会继续应用余下的 patch 补丁文件。</p>
<p>7.在任何时候，我们都可以用 –abort 参数来终止 rebase 的行动，并且分支会回到 rebase 开始前的状态。</p>
<p><code>git rebase —abort</code></p>
<h2 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h2><p>只要你的分支上需要 <code>rebase</code> 的所有 commits 历史还没有被 <code>push</code> 过，就可以安全地使用 <code>git-rebase</code>来操作。</p>
<p>因为push到远程仓库后，你再次提交时，git对比会发现两个仓库的历史不一致。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-27T00:51:09.000Z" title="2019-02-27T00:51:09.000Z">2019-02-27</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:45.943Z" title="2021-02-09T03:03:45.943Z">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span> / </span><a class="link-muted" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span><span class="level-item">5 分钟读完 (大约701个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/27/63bdd864316e.html">一种基于redis的分布式锁的实现（当前项目中在使用）</a></h1><div class="content"><p>主要思想是利用redis执行命令时的单线程特性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分布式锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedLock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DistributedLock.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁默认超时时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_TIMEOUT_SECOND = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所等待的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_WAITE_TIMEOUT_SECOND = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁循环等待时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> LOOP_WAIT_TIME_MILLISECOND = <span class="number">30</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;redisCacheService&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BaseCacheService cacheService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有超时等待的加锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutSecond      如果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waiteTimeoutSecond 若果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加锁的值（超时时间：-1表示获取失败，超时）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lock</span><span class="params">(String key, Long timeoutSecond, Long waiteTimeoutSecond)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start lock&quot;</span>);</span><br><span class="line">        <span class="keyword">long</span> beganTime = System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">//如果参数错误</span></span><br><span class="line">        <span class="keyword">if</span> (timeoutSecond != <span class="keyword">null</span> &amp;&amp; timeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            timeoutSecond = DEFAULT_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        timeoutSecond = timeoutSecond == <span class="keyword">null</span> ? DEFAULT_TIMEOUT_SECOND : timeoutSecond;</span><br><span class="line">        <span class="keyword">if</span> (waiteTimeoutSecond != <span class="keyword">null</span> &amp;&amp; waiteTimeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            waiteTimeoutSecond = DEFAULT_WAITE_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        waiteTimeoutSecond =</span><br><span class="line">                waiteTimeoutSecond == <span class="keyword">null</span> ? DEFAULT_WAITE_TIMEOUT_SECOND : waiteTimeoutSecond;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//等待超时判断</span></span><br><span class="line">            <span class="keyword">long</span> endTime = System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> ((endTime - beganTime) &gt;= waiteTimeoutSecond) &#123;</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1l</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//超时时间点</span></span><br><span class="line">            <span class="keyword">long</span> timeoutTimeMilli = cacheService.getCurrentTimeMilliForCache() + timeoutSecond * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果设置成功</span></span><br><span class="line">            <span class="keyword">if</span> (cacheService.setIfAbsent(key, timeoutTimeMilli)) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果已经超时</span></span><br><span class="line">            Long value = cacheService.getVal(key, Long.class);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.longValue() &lt; cacheService.getCurrentTimeMilliForCache()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置新的超时时间</span></span><br><span class="line">                Long oldValue = cacheService.getAndSet(key, timeoutTimeMilli);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//多个线程同时getset，只有第一个才可以获取到锁</span></span><br><span class="line">                <span class="keyword">if</span> (value.equals(oldValue)) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//延迟一定毫秒，防止请求太频繁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(LOOP_WAIT_TIME_MILLISECOND);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;DistributedLock lock sleep error&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无超时等待的加锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutSecond 如果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加锁的值（超时时间）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lock</span><span class="params">(String key, Long timeoutSecond)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果参数错误</span></span><br><span class="line">        <span class="keyword">if</span> (timeoutSecond != <span class="keyword">null</span> &amp;&amp; timeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            timeoutSecond = DEFAULT_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        timeoutSecond = timeoutSecond == <span class="keyword">null</span> ? DEFAULT_TIMEOUT_SECOND : timeoutSecond;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//超时时间点</span></span><br><span class="line">            <span class="keyword">long</span> timeoutTimeMilli = cacheService.getCurrentTimeMilliForCache() + timeoutSecond * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果设置成功</span></span><br><span class="line">            <span class="comment">// 若在redis中、没有相应的key值，那么可以认为，当前线程即或得该锁。</span></span><br><span class="line">            <span class="keyword">if</span> (cacheService.setIfAbsent(key, timeoutTimeMilli)) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果已经超时</span></span><br><span class="line">            <span class="comment">// 此时该key在redis已存在，获取该key的值</span></span><br><span class="line">            Long value = cacheService.getVal(key, Long.class);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.longValue() &lt; cacheService.getCurrentTimeMilliForCache()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置新的超时时间</span></span><br><span class="line">                <span class="comment">// 如果此时获取到的oldValue，与前面获取的value相同，则说明该线程可以获得锁</span></span><br><span class="line">                <span class="comment">// 获得锁后，set进新值。</span></span><br><span class="line">                Long oldValue = cacheService.getAndSet(key, timeoutTimeMilli);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//多个线程同时getset，只有第一个才可以获取到锁</span></span><br><span class="line">                <span class="keyword">if</span> (value.equals(oldValue)) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//延迟一定毫秒，防止请求太频繁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(LOOP_WAIT_TIME_MILLISECOND);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;DistributedLock lock sleep error&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">(String key, <span class="keyword">long</span> lockValue)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start unlock&quot;</span>);</span><br><span class="line">        Long value = cacheService.getVal(key, Long.class);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.equals(lockValue)) &#123;<span class="comment">//如果是本线程加锁</span></span><br><span class="line">            cacheService.deleteVal(key);</span><br><span class="line">            logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; unlock success&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-27T00:30:20.000Z" title="2019-02-27T00:30:20.000Z">2019-02-27</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:18.649Z" title="2021-02-09T03:03:18.649Z">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a></span><span class="level-item">2 分钟读完 (大约302个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/27/5ba82e56096a.html">LeetCode 罗马字相关</a></h1><div class="content"><p><a target="_blank" rel="noopener" href="https://leetcode.com/problems/integer-to-roman/">https://leetcode.com/problems/integer-to-roman/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> ONE[<span class="number">5</span>] = &#123;<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;M&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> FIVE[<span class="number">4</span>] =  &#123;<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;D&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> strr[<span class="number">100</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">judgeByte</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">int</span> * byte)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ten = <span class="number">10</span>, tmp = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (num / ten == <span class="number">0</span>) &#123;</span><br><span class="line">			*byte = tmp;</span><br><span class="line">			<span class="keyword">return</span> ten;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ten *= <span class="number">10</span>;</span><br><span class="line">			tmp ++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">produceRomanSymbol</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">int</span> ten, <span class="keyword">int</span> byte, <span class="keyword">char</span> * result)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (byte == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//sprintf(result + strlen(result), &quot;\n&quot;);</span></span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> target = num / (ten/<span class="number">10</span>);</span><br><span class="line">	<span class="comment">//printf(&quot;num = %d, ten = %d, target = %d, byte = %d\n&quot;, num, ten, target, byte);</span></span><br><span class="line">	<span class="keyword">if</span> (target == <span class="number">5</span>) &#123;</span><br><span class="line">		<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c&quot;</span>, FIVE[byte]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (target &gt; <span class="number">5</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (target == <span class="number">9</span>) &#123;</span><br><span class="line">			<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c%c&quot;</span>, ONE[byte], ONE[byte + <span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">			<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c&quot;</span>, FIVE[byte]);</span><br><span class="line">			<span class="keyword">for</span> (; i &lt;= (target - <span class="number">5</span>); i ++) &#123;</span><br><span class="line">				<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c&quot;</span>,  ONE[byte]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (target == <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c%c&quot;</span>, ONE[byte], FIVE[byte]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">for</span> (; i &lt;= target; i ++) &#123;</span><br><span class="line">				<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c&quot;</span>, ONE[byte]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	produceRomanSymbol(num % (ten/<span class="number">10</span>), ten / <span class="number">10</span>, byte - <span class="number">1</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">intToRoman</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> byte;</span><br><span class="line">	<span class="keyword">int</span> ten = judgeByte(num, &amp;byte);</span><br><span class="line">	<span class="built_in">memset</span>(strr, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	produceRomanSymbol(num, ten, byte, strr);</span><br><span class="line">	<span class="keyword">return</span> strr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://leetcode.com/problems/roman-to-integer/">https://leetcode.com/problems/roman-to-integer/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getRomanValue</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>: <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>: <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;X&#x27;</span>: <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>: <span class="keyword">return</span> <span class="number">50</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: <span class="keyword">return</span> <span class="number">500</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: <span class="keyword">return</span> <span class="number">1000</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">romanToInt</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>, tmp = <span class="number">0</span>, i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(s); i ++) &#123;</span><br><span class="line"><span class="comment">//		printf(&quot;i = %d, &quot;, i);</span></span><br><span class="line">		<span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">			tmp = getRomanValue(s[i]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> diff = getRomanValue(s[i]) - getRomanValue(s[i - <span class="number">1</span>]);</span><br><span class="line">			<span class="keyword">if</span> (diff == <span class="number">0</span>) &#123;</span><br><span class="line">				tmp += getRomanValue(s[i]);</span><br><span class="line"><span class="comment">//				printf(&quot;** tmp = %d, pos = %c\n&quot;, tmp, s[i]);</span></span><br><span class="line">				<span class="comment">//cnt += tmp;</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span>(diff &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				cnt += (getRomanValue(s[i]) - tmp);</span><br><span class="line"><span class="comment">//				printf(&quot;cnt = %d, pos = %c\n&quot;, cnt, s[i]);</span></span><br><span class="line">				tmp = <span class="number">0</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				cnt += tmp;</span><br><span class="line">				tmp = <span class="number">0</span>;</span><br><span class="line">				tmp += getRomanValue(s[i]);</span><br><span class="line"><span class="comment">//				printf(&quot;tmp = %d, pos = %c\n&quot;, tmp, s[i]);</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (tmp != <span class="number">0</span>)</span><br><span class="line">		cnt += tmp;</span><br><span class="line">	<span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-19T21:07:09.000Z" title="2019-02-19T21:07:09.000Z">2019-02-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:25.939Z" title="2021-02-09T03:03:25.939Z">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span> / </span><a class="link-muted" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span><span class="level-item">3 分钟读完 (大约434个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/20/5ca02b540a6b.html">nginx中的root与alias的差别</a></h1><div class="content"><h2 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h2><p>nginx指定文件路径有两种方式root和alias，指令的使用方法和作用域：<br>[root]<br>语法：root path<br>默认值：root html<br>配置段：http、server、location、if<br>[alias]<br>语法：alias path<br>配置段：location</p>
<h2 id="root与alias主要区别"><a href="#root与alias主要区别" class="headerlink" title="root与alias主要区别"></a>root与alias主要区别</h2><p>在于nginx如何解释location后面的uri，这会使两者分别以不同的方式将请求映射到服务器文件上。<br>root的处理结果是：<code>root路径 ＋ location路径</code><br>alias的处理结果是：使用alias路径替换location路径<br>alias是一个目录别名的定义，root则是最上层目录的定义。<br>还有一个重要的区别是<strong>alias后面必须要用“/”结束</strong>，否则会找不到文件的，而root则可有可无。</p>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 如果一个请求的URI是&#x2F;t&#x2F;a.html时，web服务器将会返回服务器上的&#x2F;www&#x2F;root&#x2F;html&#x2F;t&#x2F;a.html的文件。</span><br><span class="line">location ^~ &#x2F;t&#x2F; &#123;</span><br><span class="line">	root &#x2F;www&#x2F;root&#x2F;html&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 如果一个请求的URI是&#x2F;t&#x2F;a.html时，web服务器将会返回服务器上的&#x2F;www&#x2F;root&#x2F;html&#x2F;new_t&#x2F;a.html的文件。</span><br><span class="line"># 注意这里是new_t，因为alias会把location后面配置的路径丢弃掉，把当前匹配到的目录指向到指定的目录。</span><br><span class="line">location ^~ &#x2F;t&#x2F; &#123;</span><br><span class="line">	alias &#x2F;www&#x2F;root&#x2F;html&#x2F;new_t&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>使用alias时，目录名后面一定要加”/“。</li>
<li>alias在使用正则匹配时，必须捕捉要匹配的内容并在指定的内容处使用。</li>
<li>alias只能位于location块中。（root可以不放在location中）</li>
</ol>
<p>搬运工：<br>文章为: nginx.cn原创，转载请注明本文地址: <a target="_blank" rel="noopener" href="http://www.nginx.cn/4658.html">http://www.nginx.cn/4658.html</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/13/">上一页</a></div><div class="pagination-next"><a href="/page/15/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/13/">13</a></li><li><a class="pagination-link is-current" href="/page/14/">14</a></li><li><a class="pagination-link" href="/page/15/">15</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/26/">26</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-21T02:20:08.000Z">2024-02-21</time></p><p class="title"><a href="/2024/02/21/84ee50d29e8e.html">Google Pixel 7a玩机攻略</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-30T06:39:01.000Z">2024-01-30</time></p><p class="title"><a href="/2024/01/30/64634917304d.html">2024年CKS考试准备</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2023/06/26/dee71ca0ecee.html"><img src="/images/pics/wkhGYG.jpg" alt="利用OpenWrt为虚拟机做流量代理"></a></figure><div class="media-content"><p class="date"><time dateTime="2023-06-26T02:55:51.382Z">2023-06-26</time></p><p class="title"><a href="/2023/06/26/dee71ca0ecee.html">利用OpenWrt为虚拟机做流量代理</a></p><p class="categories"><a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2023/06/12/916fff7d458d.html"><img src="/images/pics/b00a1e01142bcaeee115eaab5848ce85.jpg" alt="Git 操作及原理"></a></figure><div class="media-content"><p class="date"><time dateTime="2023-06-12T07:12:22.446Z">2023-06-12</time></p><p class="title"><a href="/2023/06/12/916fff7d458d.html">Git 操作及原理</a></p><p class="categories"><a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2023/06/12/e54d04dcd0b8.html"><img src="/images/pics/Sd0C2u.jpg" alt="换行符问题"></a></figure><div class="media-content"><p class="date"><time dateTime="2023-06-12T07:08:08.170Z">2023-06-12</time></p><p class="title"><a href="/2023/06/12/e54d04dcd0b8.html">换行符问题</a></p><p class="categories"><a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="一条肥鱼" height="28"></a><p class="is-size-7"><span>&copy; 2024 一条肥鱼</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/feiyudev"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>