<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>一条肥鱼</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="一条肥鱼"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="一条肥鱼"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="一条肥鱼"><meta property="og:url" content="https://feiyu.dev/"><meta property="og:site_name" content="一条肥鱼"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://feiyu.dev/img/og_image.png"><meta property="article:author" content="一条肥鱼"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://feiyu.dev"},"headline":"一条肥鱼","image":["https://feiyu.dev/img/og_image.png"],"author":{"@type":"Person","name":"一条肥鱼"},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="一条肥鱼" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Docker">Docker</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/feiyudev"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-02-21T02:20:08.000Z" title="2024-02-21T02:20:08.000Z">2024-02-21</time>发表</span><span class="level-item"><time dateTime="2024-03-13T07:49:03.431Z" title="2024-03-13T07:49:03.431Z">2024-03-13</time>更新</span><span class="level-item">几秒读完 (大约72个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/21/84ee50d29e8e.html">Google Pixel 7a玩机攻略</a></h1><div class="content"><h2 id="获取root权限"><a href="#获取root权限" class="headerlink" title="获取root权限"></a>获取root权限</h2><p>解锁bootloader</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb reboot bootloader</span><br><span class="line">fastboot flashing unlock</span><br></pre></td></tr></table></figure>

<p>刷带magisk的init_boot.img</p>
<p>要解锁 ADB 锁屏，可以使用命令 <code>adb shell input keyevent 26</code>，这将模拟设备上的电源键按下，从而解锁屏幕。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://sspai.com/post/76276">https://sspai.com/post/76276</a></p>
<p><a target="_blank" rel="noopener" href="https://developers.google.com/android/images">https://developers.google.com/android/images</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-01-30T06:39:01.000Z" title="2024-01-30T06:39:01.000Z">2024-01-30</time>发表</span><span class="level-item"><time dateTime="2024-03-13T07:51:15.177Z" title="2024-03-13T07:51:15.177Z">2024-03-13</time>更新</span><span class="level-item">38 分钟读完 (大约5691个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/01/30/64634917304d.html">2024年CKS考试准备</a></h1><div class="content"><blockquote>
<p>Start : 2024.1.15</p>
<p>DDL1：2024.2.3 15:00 (Rescheduled)</p>
<p>DDL2：2024.2.8 20:00 (Failed)</p>
<p>DDL3:  2024.2.23 23:30 (Success)</p>
</blockquote>
<h2 id="学习环境搭建"><a href="#学习环境搭建" class="headerlink" title="学习环境搭建"></a>学习环境搭建</h2><p><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">Install Calico CNI</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Other prerequisites</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> swap,br_netfilter....</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Configure containerd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> containerd config default | sed <span class="string">&#x27;s|SystemdCgroup = false|SystemdCgroup = true|g&#x27;</span> | sudo tee /etc/containerd/config.toml &gt; /dev/null</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart containerd &amp;&amp; systemctl status containerd</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Hosts</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;127.0.0.1 kube.multipass.local&quot;</span> | sudo tee -a /etc/hosts &gt; /dev/null</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Initialize Kubernetes cluster</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm init --pod-network-cidr=10.244.0.0/16 --control-plane-endpoint kube.multipass.local</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> untaint master node</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get node --no-headers | grep control-plane | awk <span class="string">&#x27;&#123;cmd=&quot;kubectl taint node &quot;$1&quot; node-role.kubernetes.io/control-plane-&quot;;system(cmd)&#125;&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Install Calico CNI <span class="built_in">which</span> supports Network Policy</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml | sed <span class="string">&#x27;s|192.168|10.244|g&#x27;</span> | kubectl apply -f -</span></span><br></pre></td></tr></table></figure>

<p>There may be lots of impediments to setting up this kubernetes cluster successfully due to network conditions or some misconfigurations, but those above can be solved step by step. Finally, node(s) is(are) ready as follows:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get node</span></span><br><span class="line">NAME          STATUS   ROLES           AGE   VERSION</span><br><span class="line">kube-master   Ready    control-plane   21m   v1.28.3</span><br></pre></td></tr></table></figure>

<h2 id="做题工具"><a href="#做题工具" class="headerlink" title="做题工具"></a>做题工具</h2><h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alias k=kubectl                         # will already be pre-configured</span><br><span class="line">export do=&quot;--dry-run=client -o yaml&quot;    # k create deploy nginx --image=nginx $do</span><br><span class="line">export now=&quot;--force --grace-period 0&quot;   # k delete pod x $now</span><br></pre></td></tr></table></figure>

<h3 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set tabstop=2</span><br><span class="line">set expandtab</span><br><span class="line">set shiftwidth=2</span><br></pre></td></tr></table></figure>

<h3 id="jsonpath"><a href="#jsonpath" class="headerlink" title="jsonpath"></a>jsonpath</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/jsonpath/">https://kubernetes.io/docs/reference/kubectl/jsonpath/</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>
<tbody><tr>
<td><code>text</code></td>
<td>the plain text</td>
<td><code>kind is &#123;.kind&#125;</code></td>
<td><code>kind is List</code></td>
</tr>
<tr>
<td><code>@</code></td>
<td>the current object</td>
<td><code>&#123;@&#125;</code></td>
<td>the same as input</td>
</tr>
<tr>
<td><code>.</code> or <code>[]</code></td>
<td>child operator</td>
<td><code>&#123;.kind&#125;</code>, <code>&#123;[&#39;kind&#39;]&#125;</code> or <code>&#123;[&#39;name\.type&#39;]&#125;</code></td>
<td><code>List</code></td>
</tr>
<tr>
<td><code>..</code></td>
<td>recursive descent</td>
<td><code>&#123;..name&#125;</code></td>
<td><code>127.0.0.1 127.0.0.2 myself e2e</code></td>
</tr>
<tr>
<td><code>*</code></td>
<td>wildcard. Get all objects</td>
<td><code>&#123;.items[*].metadata.name&#125;</code></td>
<td><code>[127.0.0.1 127.0.0.2]</code></td>
</tr>
<tr>
<td><code>[start:end:step]</code></td>
<td>subscript operator</td>
<td><code>&#123;.users[0].name&#125;</code></td>
<td><code>myself</code></td>
</tr>
<tr>
<td><code>[,]</code></td>
<td>union operator</td>
<td><code>&#123;.items[*][&#39;metadata.name&#39;, &#39;status.capacity&#39;]&#125;</code></td>
<td><code>127.0.0.1 127.0.0.2 map[cpu:4] map[cpu:8]</code></td>
</tr>
<tr>
<td><code>?()</code></td>
<td>filter</td>
<td><code>&#123;.users[?(@.name==&quot;e2e&quot;)].user.password&#125;</code></td>
<td><code>secret</code></td>
</tr>
<tr>
<td><code>range</code>, <code>end</code></td>
<td>iterate list</td>
<td><code>&#123;range .items[*]&#125;[&#123;.metadata.name&#125;, &#123;.status.capacity&#125;] &#123;end&#125;</code></td>
<td><code>[127.0.0.1, map[cpu:4]] [127.0.0.2, map[cpu:8]]</code></td>
</tr>
<tr>
<td><code>&#39;&#39;</code></td>
<td>quote interpreted string</td>
<td><code>&#123;range .items[*]&#125;&#123;.metadata.name&#125;&#123;&#39;\t&#39;&#125;&#123;end&#125;</code></td>
<td><code>127.0.0.1 127.0.0.2</code></td>
</tr>
<tr>
<td><code>\</code></td>
<td>escape termination character</td>
<td><code>&#123;.items[0].metadata.labels.kubernetes\.io/hostname&#125;</code></td>
<td><code>127.0.0.1</code></td>
</tr>
</tbody></table>
<p>Examples using <code>kubectl</code> and JSONPath expressions:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o json</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;@&#125;&#x27;</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;.items[0]&#125;&#x27;</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span><br><span class="line">kubectl get pods -o=jsonpath=&quot;&#123;.items[*][&#x27;metadata.name&#x27;, &#x27;status.capacity&#x27;]&#125;&quot;</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;range .items[*]&#125;&#123;.metadata.name&#125;&#123;&quot;\t&quot;&#125;&#123;.status.startTime&#125;&#123;&quot;\n&quot;&#125;&#123;end&#125;&#x27;</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;.items[0].metadata.labels.kubernetes\.io/hostname&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="yq"><a href="#yq" class="headerlink" title="yq"></a>yq</h3><p>examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Read a value</span></span><br><span class="line">yq &#x27;.a.b[0].c&#x27; file.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Pipe from STDIN</span></span><br><span class="line">yq &#x27;.a.b[0].c&#x27; &lt; file.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Update a yaml file, <span class="keyword">in</span> place</span></span><br><span class="line">yq -i &#x27;.a.b[0].c = &quot;cool&quot;&#x27; file.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Find and update an item <span class="keyword">in</span> an array</span></span><br><span class="line">yq &#x27;(.[] | select(.name == &quot;foo&quot;) | .address) = &quot;12 cat st&quot;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>jq</li>
<li>tr</li>
<li>truncate</li>
<li>crictl</li>
<li>cut</li>
</ul>
<h3 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h3><p>常规使用</p>
<p>组装命令并执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc | awk &#x27;&#123;cmd=&quot;kubectl get svc &quot;$1&quot; -oyaml&quot;;system(cmd)&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>sed</li>
<li>sha512sum</li>
<li>podman(to build image)</li>
</ul>
<h3 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/cluster-administration/logging/#system-component-logs">https://kubernetes.io/docs/concepts/cluster-administration/logging/#system-component-logs</a></p>
</blockquote>
<ul>
<li><p>对 kubelet 组件：<code>journalctl -xefu kubelet</code></p>
</li>
<li><p>对以容器形式启动的 kubernetes 组件：在<code>/var/log/pods</code>下（当把kube-apiserver的yaml弄坏起不来之后，应该可以在这个目录下查看启动失败的原因）</p>
</li>
</ul>
<h3 id="group缩写问题"><a href="#group缩写问题" class="headerlink" title="group缩写问题"></a>group缩写问题</h3><p>group为空时表示<code>core</code> group，此时的 gv 缩写只有 v，即</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl api-resources --api-group=<span class="string">&#x27;&#x27;</span></span></span><br><span class="line">NAME                     SHORTNAMES   APIVERSION   NAMESPACED   KIND</span><br><span class="line">bindings                              v1           true         Binding</span><br><span class="line">componentstatuses        cs           v1           false        ComponentStatus</span><br><span class="line">configmaps               cm           v1           true         ConfigMap</span><br><span class="line">endpoints                ep           v1           true         Endpoints</span><br><span class="line">events                   ev           v1           true         Event</span><br><span class="line">limitranges              limits       v1           true         LimitRange</span><br><span class="line">namespaces               ns           v1           false        Namespace</span><br><span class="line">nodes                    no           v1           false        Node</span><br><span class="line">persistentvolumeclaims   pvc          v1           true         PersistentVolumeClaim</span><br><span class="line">persistentvolumes        pv           v1           false        PersistentVolume</span><br><span class="line">pods                     po           v1           true         Pod</span><br><span class="line">podtemplates                          v1           true         PodTemplate</span><br><span class="line">replicationcontrollers   rc           v1           true         ReplicationController</span><br><span class="line">resourcequotas           quota        v1           true         ResourceQuota</span><br><span class="line">secrets                               v1           true         Secret</span><br><span class="line">serviceaccounts          sa           v1           true         ServiceAccount</span><br><span class="line">services                 svc          v1           true         Service</span><br></pre></td></tr></table></figure>

<p>常见的控制器资源基本属于<code>apps</code> group</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                  SHORTNAMES   APIVERSION   NAMESPACED   KIND</span><br><span class="line">controllerrevisions                apps/v1      true         ControllerRevision</span><br><span class="line">daemonsets            ds           apps/v1      true         DaemonSet</span><br><span class="line">deployments           deploy       apps/v1      true         Deployment</span><br><span class="line">replicasets           rs           apps/v1      true         ReplicaSet</span><br><span class="line">statefulsets          sts          apps/v1      true         StatefulSet</span><br></pre></td></tr></table></figure>

<p>常见的几种需要填充group的地方</p>
<ul>
<li><p>rbac</p>
<p><code>role.rules.apiGroups</code> 只需要填写group</p>
</li>
<li><p>audit policy</p>
<p><code>rules.resources.group</code> 只需要填写group</p>
</li>
</ul>
<h2 id="做题方法论"><a href="#做题方法论" class="headerlink" title="做题方法论"></a>做题方法论</h2><p>客观局限</p>
<ol>
<li>网络卡顿，导致做题时及其不流畅；</li>
<li>题量大，总共有<code>16</code>道题，需要在<code>120</code>分钟内完成，完成一道题的平局时间应该120/16=<code>7</code>分钟；</li>
</ol>
<p>主观局限</p>
<ol>
<li>对安全相关的操作不熟练；</li>
<li>无做题策略，选择按顺序，从头做到尾；</li>
<li>开始做题前，未对该题进行自我评估，不确定能否短时间内搞定，做了一半，发现搞不定，非常浪费时间；</li>
</ol>
<p>改进措施</p>
<ol>
<li>改用香港/澳门移动网络漫游来做题（如果这次还是考不过，有网络卡顿的原因，下次得肉身跑到香港去了23333）；</li>
<li>及格分数需要<code>67</code>，粗略估计取得证书，需要做完<em>67/(100/16)</em>=<code>11</code>道题，可以允许<code>5</code>道题不做，但每题的平均用时为<code>10</code>分钟多一点。</li>
<li>做题步骤<ol>
<li>花<code>1</code>分钟浏览全题，理解题意，并评估是否有把握能完成；</li>
<li>没把握的用flag标记，跳过，下一题；</li>
</ol>
</li>
<li>优先去做的题目类型<ol>
<li>audit policy</li>
<li><strong>apparmor</strong></li>
<li>pod security standard</li>
<li><strong>runtime class</strong></li>
<li>image policy webhook</li>
<li><strong>trivy</strong> &amp; kube-bench</li>
<li>rbac &amp; opa</li>
<li><strong>secret</strong></li>
<li><strong>security context</strong></li>
</ol>
</li>
</ol>
<h2 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h2><h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/docs/reference/access-authn-authz/rbac/</a></p>
</blockquote>
<p>创建sa、role、rolebinding</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create sa shs-sa</span><br><span class="line">kubectl create role shs-role --resource=pods,secrets --verb=*</span><br><span class="line">kubectl create rolebinding shs-rolebinding --role=shs-role --serviceaccount=default:shs-sa</span><br></pre></td></tr></table></figure>

<p>使用该ServiceAccount</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;serviceAccountName&quot;:&quot;shs-saax&quot;,&quot;serviceAccount&quot;:&quot;shs-saax&quot;&#125;&#125;&#125;&#125;&#x27; deployment shs-dep</span><br></pre></td></tr></table></figure>

<p>Tips:</p>
<ol>
<li>如果sa异常（如：不存在），则deployment的pod不会建出来，因为rs控制器已经检测到了异常，所以未建pod。</li>
<li><code>deploy.spec.template.spec.serviceAccount</code> 与 <code>deploy.spec.template.spec.serviceAccountName</code> 都需要修改。</li>
</ol>
<h3 id="NetworkPolicy"><a href="#NetworkPolicy" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h3><h4 id="Pod-Isolation"><a href="#Pod-Isolation" class="headerlink" title="Pod Isolation"></a>Pod Isolation</h4><ul>
<li>Egress, outbound connection from pod, non-isolated by default. If NetworkPolicy selects this pod and was <code>Egress</code> type, then only out connections mentioned in it allowed. If lots of NetworkPolicy select the same pod, then all connections mentoined in those list are allowed. Additive. </li>
<li>Ingress, inbound connection to pod, non-isolated by default. Effects are as the same as Egress. Only connections mentioned by NetworkPolicy can connect to this Pod successfully.<br>Examples</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Indicates which pods this NetworkPolicy will apply to, selecting by pod&#x27;s label</span></span><br><span class="line">  <span class="comment"># podSelector: &#123;&#125; indicates this NetworkPolicy apply to all pods in default ns.</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="comment"># Defines which pod can connect to this pod.</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="comment"># both `from` and `port` rules are satitisfied, then allowed</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">        <span class="comment"># 1. IP CIDR, connections from pod whose IP in this CIDR are allowd to connect</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">            <span class="attr">cidr:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">            <span class="attr">except:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="number">172.17</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">        <span class="comment"># 2. Namespace, connection from pod whose namespace has following labels are allowed to connect</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">project:</span> <span class="string">myproject</span></span><br><span class="line">        <span class="comment"># 3. Pod, connections from pod which has following labels are allowed to connect</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">     <span class="comment"># Based on `from`, if the target port of those connection was 6379 and protocl was TCP, allowed.</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="comment"># Defines which pod can be connected by this pod</span></span><br><span class="line">  <span class="comment"># both `to` and `port` rules are satitisfied, then allowed</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">       <span class="comment"># 1. Connections from this pod can connect to this CIDR</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">            <span class="attr">cidr:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="comment"># Based on `to`, if the target port and protocol of this connection was 5978 and TCP, allowed.</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">5978</span></span><br></pre></td></tr></table></figure>

<p>parameters of <code>to</code> and <code>from</code> was the same, as follows(irrelevant informations are omitted):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl explain networkpolicy.spec.ingress</span></span><br><span class="line">  from	&lt;[]NetworkPolicyPeer&gt;</span><br><span class="line">  ports	&lt;[]NetworkPolicyPort&gt;</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl explain networkpolicy.spec.egress</span></span><br><span class="line">   to	 &lt;[]NetworkPolicyPeer&gt;</span><br><span class="line">   ports &lt;[]NetworkPolicyPort&gt;</span><br></pre></td></tr></table></figure>

<p>details of <code>NetworkPolicyPeer</code> are as follows:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl explain networkpolicy.spec.egress.to</span></span><br><span class="line">  ipBlock	&lt;IPBlock&gt;</span><br><span class="line">  namespaceSelector	&lt;LabelSelector&gt;</span><br><span class="line">  podSelector	&lt;LabelSelector&gt;</span><br></pre></td></tr></table></figure>

<p>As for details of <code>IPBlock</code> and <code>LabelSelector</code>, just <code>kubectl explain</code> before coding yamls.</p>
<h4 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h4><ul>
<li><code>NetworkPolicy</code> was namespaced, and only works in the namespace to which it belongs.</li>
<li><code>NetworkPolicy</code> can define only allowed rules.</li>
<li><code>NetworkPolicy</code> selects pod by labels only.</li>
</ul>
<h4 id="Default-network-policy"><a href="#Default-network-policy" class="headerlink" title="Default network policy"></a>Default network policy</h4><p>Deny all in &amp; out bound traffics for a pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure>

<h3 id="The-OPA-Open-Policy-Agent-Gatekeeper"><a href="#The-OPA-Open-Policy-Agent-Gatekeeper" class="headerlink" title="The OPA(Open Policy Agent) Gatekeeper"></a>The OPA(Open Policy Agent) Gatekeeper</h3><blockquote>
<p>Ref: <a target="_blank" rel="noopener" href="https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes">https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes</a></p>
</blockquote>
<p>gatekeeper admission controller 拦截所有资源的创建、更新、删除请求，并针对相关资源，做所配置的校验。</p>
<h4 id="定义校验模板"><a href="#定义校验模板" class="headerlink" title="定义校验模板"></a>定义校验模板</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">templates.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConstraintTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8srequiredlabels</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">crd:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">names:</span></span><br><span class="line">        <span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line">        <span class="attr">listKind:</span> <span class="string">K8sRequiredLabelsList</span></span><br><span class="line">        <span class="attr">plural:</span> <span class="string">k8srequiredlabels</span></span><br><span class="line">        <span class="attr">singular:</span> <span class="string">k8srequiredlabels</span></span><br><span class="line">      <span class="attr">validation:</span></span><br><span class="line">        <span class="comment"># Schema for the `parameters` field</span></span><br><span class="line">        <span class="attr">openAPIV3Schema:</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">              <span class="attr">items:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="string">admission.k8s.gatekeeper.sh</span></span><br><span class="line">      <span class="attr">rego:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">package</span> <span class="string">k8srequiredlabels</span></span><br><span class="line"></span><br><span class="line">        <span class="string">deny[&#123;&quot;msg&quot;:</span> <span class="string">msg,</span> <span class="attr">&quot;details&quot;:</span> &#123;<span class="attr">&quot;missing_labels&quot;:</span> <span class="string">missing</span>&#125;<span class="string">&#125;]</span> &#123;</span><br><span class="line">          <span class="string">provided</span> <span class="string">:=</span> &#123;<span class="string">label</span> <span class="string">|</span> <span class="string">input.review.object.metadata.labels</span>[<span class="string">label</span>]&#125;</span><br><span class="line">          <span class="string">required</span> <span class="string">:=</span> &#123;<span class="string">label</span> <span class="string">|</span> <span class="string">label</span> <span class="string">:=</span> <span class="string">input.parameters.labels</span>[<span class="string">_</span>]&#125;</span><br><span class="line">          <span class="string">missing</span> <span class="string">:=</span> <span class="string">required</span> <span class="bullet">-</span> <span class="string">provided</span></span><br><span class="line">          <span class="string">count(missing)</span> <span class="string">&gt;</span> <span class="number">0</span></span><br><span class="line">          <span class="string">msg</span> <span class="string">:=</span> <span class="string">sprintf(&quot;you</span> <span class="attr">must provide labels:</span> <span class="string">%v&quot;</span>, [<span class="string">missing</span>]<span class="string">)</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建具体约束"><a href="#创建具体约束" class="headerlink" title="创建具体约束"></a>创建具体约束</h4><p>每个命名空间都需要一个标签<code>hr</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">constraints.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ns-must-have-hr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">        <span class="attr">kinds:</span> [<span class="string">&quot;Namespace&quot;</span>]</span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;hr&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h4><p>Gatekeeper stores audit results as <code>violations</code> listed in the <code>status</code> field of the relevant Constraint.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">constraints.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ns-must-have-hr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">        <span class="attr">kinds:</span> [<span class="string">&quot;Namespace&quot;</span>]</span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;hr&quot;</span>]</span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="comment">#...</span></span><br><span class="line">  <span class="attr">violations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">enforcementAction:</span> <span class="string">deny</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;you must provide labels: &#123;&quot;hr&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">enforcementAction:</span> <span class="string">deny</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;you must provide labels: &#123;&quot;hr&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gatekeeper-system</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">enforcementAction:</span> <span class="string">deny</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;you must provide labels: &#123;&quot;hr&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-public</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">enforcementAction:</span> <span class="string">deny</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;you must provide labels: &#123;&quot;hr&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<h3 id="Apparmor"><a href="#Apparmor" class="headerlink" title="Apparmor"></a>Apparmor</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/security/apparmor/">https://kubernetes.io/docs/tutorials/security/apparmor/</a></p>
</blockquote>
<p>Confine programs or containers to limited set of resources, such as Linux capabilities, network access, file permissions, etc.</p>
<h4 id="Works-in-2-Modes"><a href="#Works-in-2-Modes" class="headerlink" title="Works in 2 Modes"></a>Works in 2 Modes</h4><ul>
<li>enforcing, blocks access</li>
<li>complain, only reports invalid access</li>
</ul>
<h4 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h4><ul>
<li>works on kubernetes v1.4 +</li>
<li>AppArmor kernel moduls enabled</li>
<li>Container Runtime supports AppArmor</li>
<li>Profile is loaded by kernel</li>
</ul>
<h4 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h4><p>Add annotations to pod which needed to be secured with key, name of container in Pod should be referred in key: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">container.apparmor.security.beta.kubernetes.io/&lt;container_name&gt;:</span> <span class="string">&lt;profile_ref&gt;</span></span><br><span class="line"><span class="string">container.apparmor.security.beta.kubernetes.io/&lt;container_name&gt;:</span> <span class="string">&lt;profile_ref&gt;</span></span><br></pre></td></tr></table></figure>

<p>The <code>profile_ref</code> can be one of:</p>
<ul>
<li><code>runtime/default</code> to apply the runtime’s default profile</li>
<li><code>localhost/&lt;profile_name&gt;</code> to apply the profile loaded on the host with the name <code>&lt;profile_name&gt;</code></li>
<li><code>unconfined</code> to indicate that no profiles will be loaded</li>
</ul>
<h4 id="Works"><a href="#Works" class="headerlink" title="Works"></a>Works</h4><ul>
<li>View Pod Events</li>
<li><code>kubectl exec &lt;pod_name&gt; -- cat /proc/1/attr/current</code></li>
</ul>
<h4 id="Helpful-commands"><a href="#Helpful-commands" class="headerlink" title="Helpful commands"></a>Helpful commands</h4><ul>
<li>Show AppArmor Status</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apparmor_status</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Load Profile to kernel</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apparmor_parser /etc/apparmor.d/nginx_apparmor</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apparmor_parser -q &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">include &lt;tunables/global&gt;</span></span><br><span class="line"></span><br><span class="line">profile k8s-apparmor-example-deny-write flags=(attach_disconnected) &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash">include &lt;abstractions/base&gt;</span></span><br><span class="line"></span><br><span class="line">  file,</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Deny all file writes.</span></span><br><span class="line">  deny /** w,</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="Audit-Policy"><a href="#Audit-Policy" class="headerlink" title="Audit Policy"></a>Audit Policy</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy">https://kubernetes.io/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/">Getting Started</a></p>
<h4 id="Stage"><a href="#Stage" class="headerlink" title="Stage"></a>Stage</h4><ul>
<li><code>RequestReceived</code> - Before handled by handler chain</li>
<li><code>ResponseStarted</code> - After response header sent, but before response body sent</li>
<li><code>ResponseComplete</code> - After response body sent</li>
<li><code>Panic</code> - After panic occurred.</li>
</ul>
<h4 id="Audit-Level"><a href="#Audit-Level" class="headerlink" title="Audit Level"></a>Audit Level</h4><ul>
<li><code>None</code> - don’t log events that match this rule</li>
<li><code>Metadata</code> - log request metadata only(user, timestamp,resource,vert) but not request or response body.</li>
<li><code>Request</code> - log event metadata plus request body</li>
<li><code>RequestResponse</code> - log event metadata plus request, response bodies.</li>
</ul>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ResponseStarted</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ResponseComplete</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Panic</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>Configure it to kube-apiserver, see audit log. </p>
<h4 id="Tips-1"><a href="#Tips-1" class="headerlink" title="Tips"></a>Tips</h4><p>If the <code>Policy</code> doesn’t work as expected, check kube-apiserver logs as below, make sure the <code>Policy</code> was loaded successfully. Since it seems to load a default <code>AuditPolicy</code> when failled to load the <code>AuditPolicy</code> passed in parameters of kube-apiserver. Logs are as below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">W0122 16:00:29.139016       1 reader.go:81] Audit policy contains errors, falling back to lenient decoding: strict decoding error: unknown field &quot;rules[0].resources[0].resource&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Pod-Security-Standard"><a href="#Pod-Security-Standard" class="headerlink" title="Pod Security Standard"></a>Pod Security Standard</h3><blockquote>
<p>Reference</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/pod-security-standards">https://kubernetes.io/docs/concepts/security/pod-security-standards</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/pod-security-admission">https://kubernetes.io/docs/concepts/security/pod-security-admission</a></li>
</ul>
</blockquote>
<h4 id="Policies"><a href="#Policies" class="headerlink" title="Policies"></a>Policies</h4><p>The Pod Security Standards define three different <em>policies</em> to broadly cover the security spectrum. These policies are <em>cumulative</em> and range from highly-permissive to highly-restrictive. This guide outlines the requirements of each policy.</p>
<p>3种策略，每种策略只是定义了检查、校验哪些字段、即校验范围。此3种策略，从上至下，校验范围依次增大。具体校验内容，可参考文档。</p>
<table>
<thead>
<tr>
<th>Profile</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Privileged</strong></td>
<td>Unrestricted policy, providing the widest possible level of permissions. This policy allows for known privilege escalations.</td>
</tr>
<tr>
<td><strong>Baseline</strong></td>
<td>Minimally restrictive policy which prevents known privilege escalations. Allows the default (minimally specified) Pod configuration.</td>
</tr>
<tr>
<td><strong>Restricted</strong></td>
<td>Heavily restricted policy, following current Pod hardening best practices.</td>
</tr>
</tbody></table>
<h4 id="Levels"><a href="#Levels" class="headerlink" title="Levels"></a>Levels</h4><p>有3种针对不符合上述3种Policy的处理方式，即<em>强制要求（否则拒绝创建）</em>、<em>记录到审计日志中</em>、<em>用户可见警告</em>。</p>
<table>
<thead>
<tr>
<th align="left">Mode</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>enforce</strong></td>
<td align="left">Policy violations will cause the pod to be rejected.</td>
</tr>
<tr>
<td align="left"><strong>audit</strong></td>
<td align="left">Policy violations will trigger the addition of an audit annotation to the event recorded in the <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/">audit log</a>, but are otherwise allowed.</td>
</tr>
<tr>
<td align="left"><strong>warn</strong></td>
<td align="left">Policy violations will trigger a user-facing warning, but are otherwise allowed.</td>
</tr>
</tbody></table>
<h4 id="Usage-1"><a href="#Usage-1" class="headerlink" title="Usage"></a>Usage</h4><p>在命名空间上打标签</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The per-mode level label indicates which policy level to apply for the mode.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># MODE must be one of `enforce`, `audit`, or `warn`.</span></span><br><span class="line"><span class="comment"># LEVEL must be one of `privileged`, `baseline`, or `restricted`.</span></span><br><span class="line"><span class="string">pod-security.kubernetes.io/&lt;MODE&gt;:</span> <span class="string">&lt;LEVEL&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional: per-mode version label that can be used to pin the policy to the</span></span><br><span class="line"><span class="comment"># version that shipped with a given Kubernetes minor version (for example v1.29).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># MODE must be one of `enforce`, `audit`, or `warn`.</span></span><br><span class="line"><span class="comment"># VERSION must be a valid Kubernetes minor version, or `latest`.</span></span><br><span class="line"><span class="string">pod-security.kubernetes.io/&lt;MODE&gt;-version:</span> <span class="string">&lt;VERSION&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="SecurityContext"><a href="#SecurityContext" class="headerlink" title="SecurityContext"></a>SecurityContext</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</a></p>
</blockquote>
<p>总共有两个安全配置的地方，位置分别为</p>
<ul>
<li><code>pod.spec.securityContext</code> 属于 <code>PodSecurityContext</code> 这个结构体，表示pod中所有的容器都使用这个配置；</li>
<li><code>pod.spec[&quot;initContainers&quot;,&quot;containers&quot;].securityContext</code> 属于 <code>SecurityContext</code> 这个结构体，只限于当前容器使用此配置，且优先级高于上面的配置。</li>
</ul>
<p>上述两种不同位置的安全配置中，有的字段是重复的，<code>SecurityContext</code> 的优先级更高。两者之间值的差异（都存在的字段已加粗）：</p>
<table>
<thead>
<tr>
<th>PodSecurityContext</th>
<th>SecurityContext</th>
</tr>
</thead>
<tbody><tr>
<td>fsGroup</td>
<td>allowPrivilegeEscalation</td>
</tr>
<tr>
<td>fsGroupChangePolicy</td>
<td>capabilities</td>
</tr>
<tr>
<td><strong>runAsGroup</strong></td>
<td>privileged</td>
</tr>
<tr>
<td><strong>runAsNonRoot</strong></td>
<td>procMount</td>
</tr>
<tr>
<td><strong>runAsUser</strong></td>
<td>readOnlyRootFilesystem</td>
</tr>
<tr>
<td><strong>seLinuxOptions</strong></td>
<td><strong>runAsGroup</strong></td>
</tr>
<tr>
<td><strong>seccompProfile</strong></td>
<td><strong>runAsNonRoot</strong></td>
</tr>
<tr>
<td>supplementalGroups</td>
<td><strong>runAsUser</strong></td>
</tr>
<tr>
<td>sysctls</td>
<td><strong>seLinuxOptions</strong></td>
</tr>
<tr>
<td><strong>windowsOptions</strong></td>
<td><strong>seccompProfile</strong></td>
</tr>
<tr>
<td></td>
<td><strong>windowsOptions</strong></td>
</tr>
</tbody></table>
<hr>
<blockquote>
<p>来源：<a target="_blank" rel="noopener" href="https://www.mrdadong.com/archives/cks-securitycontext">https://www.mrdadong.com/archives/cks-securitycontext</a></p>
</blockquote>
<p><em>按照如下要求修改 <code>sec-ns</code> 命名空间里的 Deployment <code>secdep</code></em></p>
<p><em>一、用 ID 为 30000 的用户启动容器（设置用户 ID 为: 30000 <code>runAsUser</code>）</em></p>
<p><em>二、不允许进程获得超出其父进程的特权（禁止 <code>allowPrivilegeEscalation</code>）</em></p>
<p><em>三、以只读方式加载容器的根文件系统（对根文件的只读权限<code>readOnlyRootFilesystem</code>）</em></p>
<p>注意点：</p>
<ol>
<li> <code>readOnlyRootFilesystem</code> 和 <code>allowPrivilegeEscalation</code> 只存在于<code>SecurityContext</code>中，因此需要为各个容器都配置上，需注意容器数量，避免漏配；</li>
<li><code>runAsUser</code> 存在于<code>PodSecurityContext</code> 和<code>SecurityContext</code>中，可只配 <code>PodSecurityContext</code></li>
</ol>
<h3 id="RuntimeClass"><a href="#RuntimeClass" class="headerlink" title="RuntimeClass"></a>RuntimeClass</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/runtime-class/">https://kubernetes.io/docs/concepts/containers/runtime-class/</a></p>
</blockquote>
<ul>
<li>Create <code>RuntimeClass</code></li>
<li>Specify created <code>RuntimeClass</code> in <code>pod.spec.runtimeClassName</code></li>
</ul>
<h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/secret">https://kubernetes.io/docs/concepts/configuration/secret</a></p>
</blockquote>
<ul>
<li>Secret Type</li>
<li>Mount to a pod</li>
</ul>
<hr>
<blockquote>
<p>练手速<a target="_blank" rel="noopener" href="https://www.mrdadong.com/archives/cks-Secret">【来源】</a></p>
</blockquote>
<ol>
<li><p>在 namespace <code>istio-system</code> 中获取名为 <code>db1-test</code> 的现有 secret 的内容。将 username 字段存储在名为 <code>/cks/sec/user.txt</code> 的文件中，并将 password 字段存储在名为 <code>/cks/sec/pass.txt</code> 的文件中。</p>
<p><strong>注意：你必须创建以上两个文件，他们还不存在。</strong></p>
<p><strong>注意：不要在以下步骤中使用/修改先前创建的文件，如果需要，可以创建新的临时文件。</strong></p>
</li>
<li><p>在<code>istio-system</code> namespace 中创建一个名为 <code>db2-test</code> 的新 secret，内容如下：</p>
</li>
</ol>
<ul>
<li><p>username : <code>production-instance</code></p>
</li>
<li><p>password : <code>KvLftKgs4aVH</code></p>
</li>
</ul>
<ol start="3">
<li>最后，创建一个新的 Pod，它可以通过卷访问 secret <code>db2-test</code> </li>
</ol>
<ul>
<li><p>Pod 名称 <code>secret-pod</code></p>
</li>
<li><p>Namespace <code>istio-system</code></p>
</li>
<li><p>容器名 <code>dev-container</code></p>
</li>
<li><p>镜像 <code>nginx</code></p>
</li>
<li><p>卷名 <code>secret-volume</code></p>
</li>
<li><p>挂载路径 <code>/etc/secret</code></p>
</li>
</ul>
<h3 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/service-accounts/">https://kubernetes.io/docs/concepts/security/service-accounts/</a></p>
</blockquote>
<ul>
<li>Prevent kubernetes from injecting credentials for a pod</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl explain sa.automountServiceAccountToken</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl explain pod.spec.automountServiceAccountToken</span></span><br></pre></td></tr></table></figure>

<p>Set one of fields above to <code>false</code> to prevent auto injection for a pod.</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/service-accounts/#enforce-mountable-secrets">Restrict access to Secrets</a><br>Set annotation <code>kubernetes.io/enforce-mountable-secrets</code> to <code>true</code> for a <code>ServiceAccount</code>, then only secrets in the field of <code>sa.secrets</code> of this ServiceAccount was allowed to use in a pod, such as a secret <code>volume,</code>  <code>envFrom</code>, <code>imagePullSecrets</code>.</p>
</li>
<li><p>How to use ServiceAccount to connect to apiserver? <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/access-api-from-pod">reference</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt --header &quot;Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&quot; -X GET https://kubernetes.default.svc/api/v1/namespaces/default/secrets</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">curl -k -XGET --header &quot;Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&quot;  https://kubernetes.default.svc/api/v1/namespaces/default/secrets</span><br></pre></td></tr></table></figure>

<p>整个kubeAPIServer提供了三类API Resource接口：</p>
<ul>
<li>core group：主要在 <code>/api/v1</code> 下；</li>
<li>named groups：其 path 为 <code>/apis/$GROUP/$VERSION</code>；</li>
<li>系统状态的一些 API：如<code>/metrics</code> 、<code>/version</code> 等；</li>
</ul>
<p>而API的URL大致以 <code>/apis/&#123;group&#125;/&#123;version&#125;/namespaces/&#123;namespace&#125;/&#123;resources&#125;/&#123;name&#125;</code> 组成，结构如下图所示：</p>
<p><img src="https://img2020.cnblogs.com/other/2041406/202101/2041406-20210120094608734-1433747602.png" alt="https://img2020.cnblogs.com/other/2041406/202101/2041406-20210120094608734-1433747602.png"></p>
<p>Tips:</p>
<p>在apiserver的URL中，资源需要用复数形式，如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -k -H &quot;Authorization: Bearer $(cat /run/secrets/kubernetes.io/serviceaccount/token)&quot; \</span><br><span class="line">https://kubernetes.default.svc/api/v1/namespaces/default/pods/shs-dep-b56c568d6-n8h6d</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><p>How to use <code>etcdctl</code> to get raw data from etcd?</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert=/etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key=/etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">get /registry/secrets/default -w=json | jq .</span><br></pre></td></tr></table></figure>

<h3 id="Upgrade-kubernetes-version"><a href="#Upgrade-kubernetes-version" class="headerlink" title="Upgrade kubernetes version"></a>Upgrade kubernetes version</h3><p>Follow these steps:</p>
<h4 id="for-master"><a href="#for-master" class="headerlink" title="for master"></a>for master</h4><ol>
<li><code>k drain controller-plane</code></li>
<li><code>apt-mark unhold kubeadm</code></li>
<li><code>apt-mark hold kubelet kubectl</code></li>
<li><code>apt update &amp;&amp; apt upgrade -y</code></li>
<li><code>kubeadm upgrade plan</code></li>
<li><code>kubeadm upgrade apply v1.2x.x</code></li>
<li><code>kubeadm upgrade plan(for check purpose)</code></li>
<li><code>apt-mark hold kubeadm</code></li>
<li><code>apt-mark unhold kubelet kubectl</code></li>
<li><code>apt install kubectl=1.2x.x kubelet=1.2x.x</code></li>
<li><code>apt-mark hold kubelet kubectl</code></li>
<li><code>systemctl restart kubelet</code></li>
<li><code>systemctl status kubelet</code></li>
<li><code>k uncordon controller-plane</code></li>
</ol>
<h4 id="for-node"><a href="#for-node" class="headerlink" title="for node"></a>for node</h4><ol>
<li><code>k drain node</code></li>
<li><code>apt update</code></li>
<li><code>apt-mark unhold kubeadm</code></li>
<li><code>apt-mark hold kubectl kubelet</code></li>
<li><code>apt install kubeadm=1.2x.x</code></li>
<li><code>kubeadm upgrade plan</code></li>
<li><code>kubeadm upgrade node</code></li>
<li><code>apt-mark hold kubeadm</code></li>
<li><code>apt-mark unhold kubectl kubelet</code></li>
<li><code>apt install kubectl=1.2x.x kubelet=1.2x.x</code></li>
<li><code>systemctl restart kubelet</code></li>
<li><code>systemctl status kubelet</code></li>
<li><code>k uncordon kubelet</code></li>
</ol>
<h4 id="check-upgrade-result"><a href="#check-upgrade-result" class="headerlink" title="check upgrade result"></a>check upgrade result</h4><ol>
<li><code>k get node</code></li>
</ol>
<h3 id="ImagePolicyWebhook"><a href="#ImagePolicyWebhook" class="headerlink" title="ImagePolicyWebhook"></a>ImagePolicyWebhook</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook</a></p>
</blockquote>
<h2 id="安全工具使用"><a href="#安全工具使用" class="headerlink" title="安全工具使用"></a>安全工具使用</h2><h3 id="kube-bench"><a href="#kube-bench" class="headerlink" title="kube-bench"></a>kube-bench</h3><p>A tool to detect potential security issues and give the specific means to solve the issue.</p>
<blockquote>
<p>Reference:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench/blob/main/docs/running.md">Running Method</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench">https://github.com/aquasecurity/kube-bench</a></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Simple way <span class="keyword">in</span> a kubernetes cluster created by kubeadm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply \</span></span><br><span class="line"><span class="bash">    -f https://raw.githubusercontent.com/aquasecurity/kube-bench/main/job.yaml</span></span><br></pre></td></tr></table></figure>

<p>Contents<br>Consists of the following topics:</p>
<ul>
<li>master</li>
<li>etcd</li>
<li>controlplane</li>
<li>node</li>
<li>policies</li>
</ul>
<p>Each topic starts with a list of items which was checked with checked status,  then a list of remediations to FAIL or WARN items given. You can fix those issues under the given instructions. At last,  check summary of this topic.</p>
<p>Here is a output example for topic <code>master</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[WARN] 1.1.9 Ensure that the Container Network Interface file permissions are set to 600 or more restrictive (Manual)</span><br><span class="line">[WARN] 1.1.10 Ensure that the Container Network Interface file ownership is set to root:root (Manual)</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D; Remediations master &#x3D;&#x3D;</span><br><span class="line">1.1.9 Run the below command (based on the file location on your system) on the control plane node.</span><br><span class="line">For example, chmod 600 &lt;path&#x2F;to&#x2F;cni&#x2F;files&gt;</span><br><span class="line">1.1.10 Run the below command (based on the file location on your system) on the control plane node.</span><br><span class="line">For example,</span><br><span class="line">chown root:root &lt;path&#x2F;to&#x2F;cni&#x2F;files&gt;</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D; Summary master &#x3D;&#x3D;</span><br><span class="line">38 checks PASS</span><br><span class="line">9 checks FAIL</span><br><span class="line">13 checks WARN</span><br><span class="line">0 checks INFO</span><br></pre></td></tr></table></figure>

<p>Full contexts can be touch by <a href="">this link</a></p>
<h3 id="trivy"><a href="#trivy" class="headerlink" title="trivy"></a>trivy</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://github.com/aquasecurity/trivy">https://github.com/aquasecurity/trivy</a></p>
</blockquote>
<p>Scan a docker image</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trivy image --severity LOW,MEDIUM ghcr.io&#x2F;feiyudev&#x2F;shs:latest</span><br></pre></td></tr></table></figure>

<p>扫描某命名空间下所有pod所使用的镜像包含 <code>HIGH, CRITICAL</code> 类型漏洞，并删除该pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k get pod -A -ojsonpath=&quot;&#123;range .items[*]&#125;&#123;.spec[&#x27;initContainers&#x27;,&#x27;containers&#x27;][*].image&#125; &#123;.metadata.name&#125; &#123;&#x27;#&#x27;&#125; &#123;end&#125;&quot; | sed &#x27;s|#|\n|g&#x27; | sed &#x27;s|^ ||g&#x27; | sed &#x27;s| $||g&#x27; | awk &#x27;&#123;cmd=&quot;echo &quot;$2&quot;; trivy -q image &quot;$1&quot; --severity HIGH,CRITICAL | grep Total&quot;;system(cmd)&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>该命令的注意点：</p>
<ul>
<li><code>jsonpath</code> range</li>
<li><code>awk</code> system(cmd)</li>
<li><code>sed</code> replace</li>
</ul>
<h3 id="sysdig"><a href="#sysdig" class="headerlink" title="sysdig"></a>sysdig</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://github.com/draios/sysdig">https://github.com/draios/sysdig</a></p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=UJ4wVrbP-Q8">Video</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linhaostudy/p/17017114.html">Usage</a></li>
</ul>
<h4 id="Installation-Based-on-Ubuntu-22-04"><a href="#Installation-Based-on-Ubuntu-22-04" class="headerlink" title="Installation(Based on Ubuntu 22.04)"></a>Installation(Based on Ubuntu 22.04)</h4><ul>
<li>Download <code>deb</code> from <a target="_blank" rel="noopener" href="https://github.com/draios/sysdig/releases">sysdig-release</a></li>
<li><code>sudo dpkg -i sysdig-0.34.1-x86_64.deb</code></li>
<li><code>sudo apt -f install</code></li>
</ul>
<h4 id="Output-format"><a href="#Output-format" class="headerlink" title="Output format"></a>Output format</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%evt.num %evt.outputtime %evt.cpu %proc.name (%thread.tid) %evt.dir %evt.type %evt.info</span><br><span class="line">173884 15:06:10.075401786 7 sudo (1453517.1453517) &gt; read fd&#x3D;9(&lt;f&gt;&#x2F;dev&#x2F;ptmx) size&#x3D;65536</span><br></pre></td></tr></table></figure>

<p>Notes: </p>
<ol>
<li><code>evt.dir</code> aka event direction, &lt; represents out, &gt; represents in.</li>
<li><code>evt.type</code> aka event type, perceiving it as a name of system call.</li>
</ol>
<h4 id="Chisels"><a href="#Chisels" class="headerlink" title="Chisels"></a>Chisels</h4><p>predefined function sets based on sysdig events, to implements complex situation. Locates in <code>/usr/share/sysdig/chisels</code> on Linux machine. </p>
<p>What are those chisels?</p>
<ol>
<li>To see chisels.</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysdig -cl</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">sysdig --list-chisels</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>To use a chisel</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> See HTTP <span class="built_in">log</span></span></span><br><span class="line">sysdig -c httplog</span><br><span class="line">2024-01-25 23:06:16.423272777 &lt; method=GET url=:8080/health response_code=200 latency=0ms size=2B</span><br><span class="line">2024-01-25 23:06:16.423299653 &gt; method=GET url=:8080/health response_code=200 latency=0ms size=2B</span><br><span class="line"><span class="meta">#</span><span class="bash"> See CPU usage ranking</span></span><br><span class="line">sysdig -c topprocs_cpu</span><br><span class="line"><span class="meta">CPU%</span><span class="bash">                Process             PID</span></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">8.01%               kube-apiserver      39124</span><br><span class="line">3.00%               kubelet             25007</span><br><span class="line">3.00%               etcd                1613</span><br><span class="line">2.00%               sysdig              102489</span><br><span class="line">2.00%               kube-controller     38957</span><br><span class="line">2.00%               calico-node         4705</span><br><span class="line">1.00%               containerd          874</span><br><span class="line">1.00%               vmtoolsd            790</span><br><span class="line">1.00%               kube-scheduler      39017</span><br><span class="line">0.00%               svlogd              2505</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Advanced usage about a chisel</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sysdig -i spy_file</span></span><br><span class="line"></span><br><span class="line">Category: I/O</span><br><span class="line">-------------</span><br><span class="line">spy_file        Echo any read/write made by any process to all files. Optionall</span><br><span class="line">                y, you can provide the name of one file to only intercept reads</span><br><span class="line">                /writes to that file.</span><br><span class="line"></span><br><span class="line">This chisel intercepts all reads and writes to all files. Instead of all files,</span><br><span class="line"> you can limit interception to one file.</span><br><span class="line">Args:</span><br><span class="line">[string] read_or_write - Specify &#x27;R&#x27; to capture only read event</span><br><span class="line">                s; &#x27;W&#x27; to capture only write events; &#x27;RW&#x27; to capture read and w</span><br><span class="line">                rite events. By default both read and write events are captured</span><br><span class="line">                .</span><br><span class="line">[string] spy_on_file_name - The name of the file which the chis</span><br><span class="line">                el should spy on for all read and write activity.</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sysdig -c spy_file <span class="string">&quot;RW /root/spy_file_test.txt&quot;</span></span></span><br><span class="line">23:53:25.592303985 date(112109) W 32B /root/spy_file_test.txt</span><br><span class="line">Thu Jan 25 11:53:25 PM HKT 2024</span><br><span class="line"></span><br><span class="line">23:53:43.333152845 cat(112206) R 32B /root/spy_file_test.txt</span><br><span class="line">Thu Jan 25 11:53:25 PM HKT 2024</span><br><span class="line"></span><br><span class="line">23:53:43.333166670 cat(112206) R 0B /root/spy_file_test.txt NULL</span><br><span class="line">23:53:51.856062624 date(112270) W 32B /root/spy_file_test.txt</span><br><span class="line">Thu Jan 25 11:53:51 PM HKT 2024</span><br><span class="line"></span><br><span class="line">23:53:56.965894638 cat(112307) R 64B /root/spy_file_test.txt</span><br><span class="line">Thu Jan 25 11:53:25 PM HKT 2024</span><br><span class="line">Thu Jan 25 11:53:51 PM HKT 2024</span><br><span class="line"></span><br><span class="line">23:53:56.965902094 cat(112307) R 0B /root/spy_file_test.txt NULL</span><br></pre></td></tr></table></figure>

<h4 id="Usage-2"><a href="#Usage-2" class="headerlink" title="Usage"></a>Usage</h4><ol>
<li>Save events to a file</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -w test.scap</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Read events from a file while analyzing (by chisels)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -r test.scap -c httptop</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Specify the format to be used when printing the events<br>-p <output_format>, –print=<output_format><br> Specify the format to be used when printing the events.<br> With -pc or -pcontainer will use a container-friendly format.<br> With -pk or -pkubernetes will use a kubernetes-friendly format.<br> With -pm or -pmesos will use a mesos-friendly format.<br> See the examples section below for more info.</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -r test.scap -c httptop -pc</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Specify the number of events Sysdig should capture by passing it the -n flag. Once Sysdig captures the specified number of events, it’ll automatically exit:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -n 5000 -w test.scap</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>Use the -C flag to configure Sysdig so that it breaks the capture into smaller files of a specified size.<br>The following example continuously saves events to files &lt; 10MB:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -C 10 -w test.scap</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Specify the maximum number of files Sysdig should keep with the -W flag. For example, you can combine the -C and -W flags like so:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -C 10 -W 4 -w test.scap</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>You can analyze the processes running in the WordPress container with:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -pc -c topprocs_cpu container.name=wordpress-sysdig_wordpress_1</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>-M <num_seconds>   Stop collecting after <num_seconds> reached.</li>
</ol>
<h4 id="Help"><a href="#Help" class="headerlink" title="Help"></a>Help</h4><p>关于filter可用的字段，可以通过<code>sysdig -l</code>来查看所有支持的字段。例如查看容器相关的过滤字段，有：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@primary:~$ sysdig -l | grep &quot;^container.&quot;</span><br><span class="line">container.id                  The truncated container ID (first 12 characters), e.g. 3ad7b26ded6d is extracted from the</span><br><span class="line">container.full_id             The full container ID, e.g.</span><br><span class="line">container.name                The container name. In instances of userspace container engine lookup delays, this field</span><br><span class="line">container.image               The container image name (e.g. falcosecurity/falco:latest for docker). In instances of</span><br><span class="line">container.image.id            The container image id (e.g. 6f7e2741b66b). In instances of userspace container engine</span><br><span class="line">container.type                The container type, e.g. docker, cri-o, containerd etc.</span><br><span class="line">container.privileged          &#x27;true&#x27; for containers running as privileged, &#x27;false&#x27; otherwise. In instances of userspace</span><br><span class="line">container.mounts              A space-separated list of mount information. Each item in the list has the format</span><br><span class="line">container.mount               (ARG_REQUIRED) Information about a single mount, specified by number (e.g.</span><br><span class="line">container.mount.source        (ARG_REQUIRED) The mount source, specified by number (e.g. container.mount.source[0]) or</span><br><span class="line">container.mount.dest          (ARG_REQUIRED) The mount destination, specified by number (e.g. container.mount.dest[0])</span><br><span class="line">container.mount.mode          (ARG_REQUIRED) The mount mode, specified by number (e.g. container.mount.mode[0]) or</span><br><span class="line">container.mount.rdwr          (ARG_REQUIRED) The mount rdwr value, specified by number (e.g. container.mount.rdwr[0])</span><br><span class="line">container.mount.propagation   (ARG_REQUIRED) The mount propagation value, specified by number (e.g.</span><br><span class="line">container.image.repository    The container image repository (e.g. falcosecurity/falco). In instances of userspace</span><br><span class="line">container.image.tag           The container image tag (e.g. stable, latest). In instances of userspace container engine</span><br><span class="line">container.image.digest        The container image registry digest (e.g.</span><br><span class="line">container.healthcheck         The container&#x27;s health check. Will be the null value (&quot;N/A&quot;) if no healthcheck</span><br><span class="line">container.liveness_probe      The container&#x27;s liveness probe. Will be the null value (&quot;N/A&quot;) if no liveness probe</span><br><span class="line">container.readiness_probe     The container&#x27;s readiness probe. Will be the null value (&quot;N/A&quot;) if no readiness probe</span><br><span class="line">container.start_ts            Container start as epoch timestamp in nanoseconds based on proc.pidns_init_start_ts and</span><br><span class="line">container.duration            Number of nanoseconds since container.start_ts.</span><br><span class="line">container.ip                  The container&#x27;s / pod&#x27;s primary ip address as retrieved from the container engine. Only</span><br><span class="line">container.cni.json            The container&#x27;s / pod&#x27;s CNI result field from the respective pod status info. It contains</span><br></pre></td></tr></table></figure>

<p>可以看出，<code>container.id</code>只能取前12个字符，另外也可以用容器id的全名，即<code>container.full_id</code>。另外k8s可支持的字段有：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@primary:~$ sysdig -l | grep &quot;^k8s.&quot;</span><br><span class="line">k8s.ns.name                   The Kubernetes namespace name. This field is extracted from the container runtime socket</span><br><span class="line">k8s.pod.name                  The Kubernetes pod name. This field is extracted from the container runtime socket</span><br><span class="line">k8s.pod.id                    [LEGACY] The Kubernetes pod UID, e.g. 3e41dc6b-08a8-44db-bc2a-3724b18ab19a. This legacy</span><br><span class="line">k8s.pod.uid                   The Kubernetes pod UID, e.g. 3e41dc6b-08a8-44db-bc2a-3724b18ab19a. Note that the pod UID</span><br><span class="line">k8s.pod.sandbox_id            The truncated Kubernetes pod sandbox ID (first 12 characters), e.g 63060edc2d3a. The</span><br><span class="line">k8s.pod.full_sandbox_id       The full Kubernetes pod / sandbox ID, e.g</span><br><span class="line">k8s.pod.label                 (ARG_REQUIRED) The Kubernetes pod label. The label can be accessed either with the</span><br><span class="line">k8s.pod.labels                The Kubernetes pod comma-separated key/value labels. E.g. &#x27;foo1:bar1,foo2:bar2&#x27;. This</span><br><span class="line">k8s.pod.ip                    The Kubernetes pod ip, same as container.ip field as each container in a pod shares the</span><br><span class="line">k8s.pod.cni.json              The Kubernetes pod CNI result field from the respective pod status info, same as</span><br></pre></td></tr></table></figure>

<h4 id="Traps"><a href="#Traps" class="headerlink" title="Traps"></a>Traps</h4><blockquote>
<p>此处有坑</p>
</blockquote>
<p>使用<code>container.id</code>过滤时，注意id的长度需要为<code>12</code>，不然数据出不来。通过<code>crictl ps</code>看到的<code>container id</code>是<strong>13</strong>位的，使用sysdig时，需要注意长度。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@primary:~$ crictl ps | grep -v ^C | awk &#x27;&#123;print $1,$2,$6,$7&#125;&#x27;</span><br><span class="line">0fd88042f1ddf 848c5b919e8d3 Running calico-apiserver</span><br><span class="line">ad81cac0dbf9e 848c5b919e8d3 Running calico-apiserver</span><br><span class="line">f6d6b81c75f69 4e87edec0297d Running calico-kube-controllers</span><br><span class="line">87c4fbddeb123 d36ef67f7b24c Running csi-node-driver-registrar</span><br><span class="line">46095b3ea4bf6 91c1c91da7602 Running calico-csi</span><br><span class="line">51e65353815dc cbb01a7bd410d Running coredns</span><br><span class="line">7fc6f4ad4aafa cbb01a7bd410d Running coredns</span><br><span class="line">de42d610f5530 1843802b91be8 Running calico-node</span><br><span class="line">21ae9adf53e47 b33768e0da1f8 Running calico-typha</span><br><span class="line">a2f7701ceae6c 7bc79e0d3be4f Running tigera-operator</span><br><span class="line">d91edc95d2edf 9344fce2372f8 Running kube-proxy</span><br><span class="line">5f7d85179ade0 6fc5e6b7218c7 Running kube-scheduler</span><br><span class="line">d40dd28cc171c 138fb5a3a2e34 Running kube-controller-manager</span><br><span class="line">c71d33c5aea6e 8a9000f98a528 Running kube-apiserver</span><br><span class="line">0cdeff9542f15 a0eed15eed449 Running etcd</span><br></pre></td></tr></table></figure>

<h3 id="falco"><a href="#falco" class="headerlink" title="falco"></a>falco</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://falco.org/docs">https://falco.org/docs</a></p>
</blockquote>
<h3 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h3><p>监控<u>进程</u>的<strong>系统调用</strong>和<strong>信号量</strong>，基础的使用方式</p>
<ol>
<li>监听某个已存在的进程 <code>strace -p &lt;pid&gt;</code></li>
<li>直接启动一个二进制 <code>strace &lt;binary-name&gt;</code></li>
<li>对输出结果进行过滤 <code>strace -e trace=file</code></li>
</ol>
<h2 id="考试说明书"><a href="#考试说明书" class="headerlink" title="考试说明书"></a>考试说明书</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.linuxfoundation.org/tc-docs/certification/important-instructions-cks">Handbook of CKS exam</a></p>
</blockquote>
<p>Requirments of your computer, microphone, camera, speaker, etc.</p>
<blockquote>
<p>Don’t use headphone, earbuds.</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://helpdesk.psionline.com/hc/en-gb/articles/4409608794260-PSI-Bridge-Platform-System-Requirements">[PSI Bridge FAQ] System Requirements</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.linuxfoundation.org/tc-docs/certification/important-instructions-cks#system-requirements-to-take-the-exam">System Requirements to take the exam</a></li>
<li>Browser recommand Google Chrome</li>
</ul>
<p>Exam Details</p>
<p>Online tests, <strong>15-20</strong> performance-based tasks, <strong>2 hours</strong> to complete the tasks.</p>
<p>Don’t cheat, audio,camera,screen capture of the test will be reviewed.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-26T02:55:51.382Z" title="2023-06-26T02:55:51.382Z">2023-06-26</time>发表</span><span class="level-item"><time dateTime="2023-06-26T02:55:51.382Z" title="2023-06-26T02:55:51.382Z">2023-06-26</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></span><span class="level-item">6 分钟读完 (大约910个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/26/dee71ca0ecee.html">利用OpenWrt为虚拟机做流量代理</a></h1><div class="content"><h2 id="安装Openwrt虚拟机"><a href="#安装Openwrt虚拟机" class="headerlink" title="安装Openwrt虚拟机"></a>安装Openwrt虚拟机</h2><p>下载镜像：<a target="_blank" rel="noopener" href="https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/">Index of /releases/22.03.5/targets/x86/64/ (openwrt.org)</a></p>
<p>转换镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert -f raw -O vdi openwrt-22.03.5-x86-64-generic-ext4-combined-efi.img openwrt-22.03.5-x86-64-generic-ext4-combined-efi.img.vdi</span><br></pre></td></tr></table></figure>

<p>配置虚拟机网卡：</p>
<ol>
<li><p>在VirtualBox中新建HostNetwork（Host-Only网络），网段为<code>192.168.56.0/24</code></p>
<p>  <img src="/images/pics/SbXZGH.png"></p>
</li>
<li><p>在openwrt虚拟机的网络选项中设置：</p>
<p>  1）启用<code>网卡1</code>，连接方式选<code>仅主机网络</code>，名称选上步创建的<code>HostNetwork</code></p>
<p>  <img src="/images/pics/tsfpEu.png"></p>
<p>  2）启用<code>网卡2</code>，连接方式选<code>桥接</code>网卡，名称选<code>本机上能访问外网的网卡</code></p>
<p>  <img src="/images/pics/RiQaah.png"></p>
</li>
<li><p>  进入openwrt虚拟机，为lan口设置静态IP地址为<code>HostNetwork</code>中的一个IP，这里用 <code>192.168.56.2</code></p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># cat /etc/config/network</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;loopback&#x27;</span></span><br><span class="line">	option device <span class="string">&#x27;lo&#x27;</span></span><br><span class="line">	option proto <span class="string">&#x27;static&#x27;</span></span><br><span class="line">	option ipaddr <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">	option netmask <span class="string">&#x27;255.0.0.0&#x27;</span></span><br><span class="line"></span><br><span class="line">config globals <span class="string">&#x27;globals&#x27;</span></span><br><span class="line">	option ula_prefix <span class="string">&#x27;fdd4:bccc:9ebb::/48&#x27;</span></span><br><span class="line"></span><br><span class="line">config device</span><br><span class="line">	option name <span class="string">&#x27;br-lan&#x27;</span></span><br><span class="line">	option <span class="built_in">type</span> <span class="string">&#x27;bridge&#x27;</span></span><br><span class="line">	list ports <span class="string">&#x27;eth0&#x27;</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;lan&#x27;</span></span><br><span class="line">	option device <span class="string">&#x27;br-lan&#x27;</span></span><br><span class="line">	option proto <span class="string">&#x27;static&#x27;</span></span><br><span class="line">	option ipaddr <span class="string">&#x27;192.168.56.2&#x27;</span></span><br><span class="line">	option netmask <span class="string">&#x27;255.255.255.0&#x27;</span></span><br><span class="line">	option ip6assign <span class="string">&#x27;60&#x27;</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;wan&#x27;</span></span><br><span class="line">	option device <span class="string">&#x27;eth1&#x27;</span></span><br><span class="line">	option proto <span class="string">&#x27;dhcp&#x27;</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;wan6&#x27;</span></span><br><span class="line">	option device <span class="string">&#x27;eth1&#x27;</span></span><br><span class="line">	option proto <span class="string">&#x27;dhcpv6&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="OPENWRT开启SFTP，实现文件下载上传"><a href="#OPENWRT开启SFTP，实现文件下载上传" class="headerlink" title="OPENWRT开启SFTP，实现文件下载上传"></a>OPENWRT开启SFTP，实现文件下载上传</h2><p>同时也能使用<code>scp</code>命令进行拷贝</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install vsftpd openssh-sftp-server</span><br><span class="line">/etc/init.d/vsftpd enable</span><br><span class="line">/etc/init.d/vsftpd start</span><br></pre></td></tr></table></figure>

<h2 id="OpenClash安装与配置"><a href="#OpenClash安装与配置" class="headerlink" title="OpenClash安装与配置"></a>OpenClash安装与配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#iptables</span></span><br><span class="line">opkg update</span><br><span class="line">opkg install coreutils-nohup bash iptables dnsmasq-full curl ca-certificates ipset ip-full iptables-mod-tproxy iptables-mod-extra libcap libcap-bin ruby ruby-yaml kmod-tun kmod-inet-diag unzip luci-compat luci luci-base</span><br></pre></td></tr></table></figure>

<p>如果需要强制安装，可以先<code>opkg remove</code>，再<code>opkg install</code>。</p>
<p>在<a target="_blank" rel="noopener" href="https://github.com/vernesong/OpenClash/releases">Releases · vernesong/OpenClash (github.com)</a>页面，将openclash安装包下载到openwrt虚拟机中，通过 <code>opkg install</code> 安装。</p>
<p>配置手册：<a target="_blank" rel="noopener" href="https://github.com/vernesong/OpenClash/wiki">Home · vernesong/OpenClash Wiki (github.com)</a></p>
<h2 id="其他虚拟机的旁路由配置"><a href="#其他虚拟机的旁路由配置" class="headerlink" title="其他虚拟机的旁路由配置"></a>其他虚拟机的旁路由配置</h2><p>此处用的是ubuntu server，可以在安装界面时设置，也可以等安装完成后，手动修改配置。手动修改的配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/netplan/00-installer-config.yaml</span><br><span class="line"><span class="comment"># This is the network config written by &#x27;subiquity&#x27;</span></span><br><span class="line">network:</span><br><span class="line">  ethernets:</span><br><span class="line">    enp0s3:</span><br><span class="line">      addresses:</span><br><span class="line">      - 192.168.56.3/24</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses:</span><br><span class="line">        - 114.114.114.114</span><br><span class="line">        search: []</span><br><span class="line">      routes:</span><br><span class="line">      - to: default</span><br><span class="line">        via: 192.168.56.2</span><br><span class="line">  version: 2</span><br></pre></td></tr></table></figure>

<p>配置修改后，可以看到默认路由已变成 <code>192.168.56.2</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ip route</span><br><span class="line">default via 192.168.56.2 dev enp0s3 proto static</span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown</span><br><span class="line">192.168.56.0/24 dev enp0s3 proto kernel scope link src 192.168.56.3</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/peiyake/OpenWrt/blob/master/%E5%88%A9%E7%94%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85X86%E4%B9%8BOpenWrt.md">OpenWrt/利用虚拟机安装X86之OpenWrt.md at master · peiyake/OpenWrt · GitHub</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://blog.51cto.com/linhong/5732213?u_atoken=b1dfb976-4d17-480c-9e72-21b2e268125c&u_asession=01Zgb-7A1LJgNfIsZ6SBoHApYOmNdmMagWKG_cVkzggQ9OPfEANhgRG6KbJeehsF0OX0KNBwm7Lovlpxjd_P_q4JsKWYrT3W_NKPr8w6oU7K8JOUVx0zGHY3UZmuDw1M44z93Gv091IdoFlCkcaxHIZGBkFo3NEHBv0PZUm6pbxQU&u_asig=05jbnufJzzl_zFfBjk7-M9al3uZYxUoDisE7G6G1moNNOZrOVXjw99WcjSIUhuuZMv5_LWGHRaWbCZF__xR3I_uAb88AMVBRgUwJtOyAtv8P7E3Ot1Vul_NI1YtOGuqF2r3lI4pfoKRiCqpFymhSG6cTB9VaxOkhgX5yDVfv4JVwb9JS7q8ZD7Xtz2Ly-b0kmuyAKRFSVJkkdwVUnyHAIJzdU6bOLR3imc2qYkb7-r3jSGLAs8vppC-uwpaylREQ2jIZvi_fHA0gZ5NR9OtWDag-3h9VXwMyh6PgyDIVSG1W8_f_100H14AIJGfb4dxLkFj7fGLiguhfvrRmLpZQrmWsonxVoSsce7wLOWDU_1h8bOwtAvCqOJkmDhcbtBvzTdmWspDxyAEEo4kbsryBKb9Q&u_aref=4OwndGGPcd7GrKOKOYzCaiu7UwM=">VMware Workstation安装软路由OpenWrt_林鸿风采的技术博客_51CTO博客</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/352119348">VirtualBox虚拟机安装openwrt供本机使用 - 知乎 (zhihu.com)</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://blog.csdn.net/w946612410/article/details/113997146">VMware安装OpenWrt让宿主机上网&amp;旁路由（两种方案）_vmware openwrt旁路由_aglo的博客-CSDN博客</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/334419721">如何在vmware虚拟机中安装OpenWrt系统？ - 知乎 (zhihu.com)</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://open.toutiao.com/a6951804532821115425/?utm_source=vivoliulanqi&utm_medium=webview&utm_campaign=open&label=related_news&item_id=6951804532821115425&gy=15d46571dc484c3e19063c7fcea60edb1164a6df680e4273fe3c93dc0a6be0bcb0ada9ce3d308ad36b9971e32292e6e8459cedbaf8be1611d2e7ea18469dbeb5b39eedea53b77527817f665ec4fb0653ea354af990a4802de57f2c70111b7028b593f4eff9ba863c654d354c2565d4b6fe4784a0e35ef371325958ec95f33&fr=normal&isRelated=1&isNews=1&req_id=202106161014310102121441550F4825EE&vivoRcdMark=1&from_gid=6945021964322980390&channel_id=88805669586">软路由OpenWrt X86软路由安装 (toutiao.com)</a></p>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-12T07:12:22.446Z" title="2023-06-12T07:12:22.446Z">2023-06-12</time>发表</span><span class="level-item"><time dateTime="2023-06-12T07:12:22.446Z" title="2023-06-12T07:12:22.446Z">2023-06-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></span><span class="level-item">2 分钟读完 (大约229个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/12/916fff7d458d.html">Git 操作及原理</a></h1><div class="content"><h2 id="Git-Diff-的工作原理"><a href="#Git-Diff-的工作原理" class="headerlink" title="Git Diff 的工作原理"></a>Git Diff 的工作原理</h2><p><a target="_blank" rel="noopener" href="https://chenshinan.github.io/2019/05/02/git%E7%94%9F%E6%88%90diff%E5%8E%9F%E7%90%86%EF%BC%9AMyers%E5%B7%AE%E5%88%86%E7%AE%97%E6%B3%95/">Myers差分算法</a></p>
<h2 id="创建基于某个-commit-id-的分支"><a href="#创建基于某个-commit-id-的分支" class="headerlink" title="创建基于某个 commit id 的分支"></a>创建基于某个 commit id 的分支</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b dev c99d6500</span><br></pre></td></tr></table></figure>

<h2 id="查看指定分支的提交"><a href="#查看指定分支的提交" class="headerlink" title="查看指定分支的提交"></a>查看指定分支的提交</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git log master</span><br><span class="line">git config --global alias.nicelog &quot;log --graph --abbrev-commit --pretty=format:&#x27;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&#x27;&quot;</span><br></pre></td></tr></table></figure>
<p>如下所示：<br><img src="/images/pics/seWuLx.png"></p>
<h2 id="git-如何存储"><a href="#git-如何存储" class="headerlink" title="git 如何存储"></a>git 如何存储</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tonybai.com/2020/04/07/illustrated-tale-of-git-internal-key-concepts/">图解git原理的几个关键概念</a></li>
</ul>
<h2 id="git-如何-merge"><a href="#git-如何-merge" class="headerlink" title="git 如何 merge"></a>git 如何 merge</h2><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021712743">git merge的原理（递归三路合并算法）</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904175508127751">当我们git-merge的时候到底在merge什么.</a></li>
</ul>
<h2 id="git-如何-rebase"><a href="#git-如何-rebase" class="headerlink" title="git 如何 rebase"></a>git 如何 rebase</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/AhuntSun-blog/p/12732946.html">Git应用详解第九讲：Git cherry-pick与Git rebase</a></li>
</ul>
<h2 id="是否能-cherry-pick-所有的-commit"><a href="#是否能-cherry-pick-所有的-commit" class="headerlink" title="是否能 cherry-pick 所有的 commit"></a>是否能 cherry-pick 所有的 commit</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/AhuntSun-blog/p/12732946.html">Git应用详解第九讲：Git cherry-pick与Git rebase</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-12T07:08:08.170Z" title="2023-06-12T07:08:08.170Z">2023-06-12</time>发表</span><span class="level-item"><time dateTime="2023-06-12T07:08:43.667Z" title="2023-06-12T07:08:43.667Z">2023-06-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></span><span class="level-item">8 分钟读完 (大约1255个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/12/e54d04dcd0b8.html">换行符问题</a></h1><div class="content">问题Linux 环境执行一些脚本出错，查找原因，发现是文件在Windows环境修改并上传，格式被转换为MS-Dos格式（换行符不同），这样的文件在Linux中运行会出错（shell 解释器把换行符作为一个命令的提交）。背景很久以前，老式的电传打字机使用两个字符来另起新行。回车符(CR，carriag</div><a class="article-more button is-small is-size-7" href="/2023/06/12/e54d04dcd0b8.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-12T07:04:28.491Z" title="2023-06-12T07:04:28.491Z">2023-06-12</time>发表</span><span class="level-item"><time dateTime="2023-06-12T07:04:28.491Z" title="2023-06-12T07:04:28.491Z">2023-06-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">4 分钟读完 (大约542个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/12/1c3fe39c1f3f.html">Certified Calico Operator: Level 1 笔记</a></h1><div class="content"><p>证书课程地址：<a target="_blank" rel="noopener" href="https://courses.academy.tigera.io/courses/course-v1:tigera+CCO-L1+CCO-L1-2020/course/">Course | CCO-L1 | Tigera</a><br>还有一份可能有用的电子书：<br><a target="_blank" rel="noopener" href="https://www.yuque.com/attachments/yuque/0/2022/pdf/34563650/1672383996979-dd110bd9-c119-4ead-b080-424ba48861c7.pdf">Tigera_eBook_Intro_to_Kubernetes_Networking.pdf</a></p>
<h3 id="Kubernetes-Network-Model"><a href="#Kubernetes-Network-Model" class="headerlink" title="Kubernetes Network Model"></a>Kubernetes Network Model</h3><ol>
<li>每个 Pod 都有一个 IP 地址；</li>
<li>同一个 Pod 中的容器共享同一 IP 地址，并能通过该地址相互通信；</li>
<li>Pod 与 Pod 之间可以通过 IP 通信（无需地址转换）；</li>
<li>网络隔离可以限制哪里 Pod 可以访问哪些不可以。</li>
</ol>
<p><img src="/images/pics/oNK9Sp.jpg"></p>
<h3 id="安装测试集群"><a href="#安装测试集群" class="headerlink" title="安装测试集群"></a>安装测试集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl https://raw.githubusercontent.com/tigera/ccol1/main/control-init.yaml | multipass launch -n control -m 2048M 20.04 --cloud-init -</span><br><span class="line">curl https://raw.githubusercontent.com/tigera/ccol1/main/node1-init.yaml | multipass launch -n node1 20.04 --cloud-init -</span><br><span class="line">curl https://raw.githubusercontent.com/tigera/ccol1/main/node2-init.yaml | multipass launch -n node2 20.04 --cloud-init -</span><br><span class="line">curl https://raw.githubusercontent.com/tigera/ccol1/main/host1-init.yaml | multipass launch -n host1 20.04 --cloud-init -</span><br></pre></td></tr></table></figure>
<p>重启系统后，可能需要启动所有的虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multipass start --all</span><br></pre></td></tr></table></figure>
<h3 id="安装-Calico"><a href="#安装-Calico" class="headerlink" title="安装 Calico"></a>安装 Calico</h3><p>4 种安装方式</p>
<ul>
<li>Manifest</li>
<li>Operator</li>
<li>Managed Kubernetes Services</li>
<li>Kubernetes Distros and Installers<h4 id="Operator-方式安装"><a href="#Operator-方式安装" class="headerlink" title="Operator 方式安装"></a>Operator 方式安装</h4>可参考：<a target="_blank" rel="noopener" href="https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart">Quickstart for Calico on Kubernetes</a><br>注意事项：</li>
</ul>
<ol>
<li>Pod 的网段</li>
<li>calico 版本与 kubernetes 版本之间的兼容关系（最好就用教程里面的安装命令）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://docs.projectcalico.org/archive/v3.21/manifests/tigera-operator.yaml</span><br><span class="line">cat &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: operator.tigera.io/v1</span></span><br><span class="line"><span class="string">kind: Installation</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  calicoNetwork:</span></span><br><span class="line"><span class="string">    containerIPForwarding: Enabled</span></span><br><span class="line"><span class="string">    ipPools:</span></span><br><span class="line"><span class="string">    - cidr: 198.19.16.0/20</span></span><br><span class="line"><span class="string">      natOutgoing: Enabled</span></span><br><span class="line"><span class="string">      encapsulation: None</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
删除 tigera-operator 命名空间<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-XPUT \</span><br><span class="line">-d <span class="string">&#x27;&#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Namespace&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;tigera-operator&quot;&#125;,&quot;spec&quot;:&#123;&quot;finalizers&quot;:[]&#125;&#125;&#x27;</span> \</span><br><span class="line">http://localhost:8001/api/v1/namespaces/tigera-operator/finalize</span><br></pre></td></tr></table></figure>
相关 Pod 的工作内容：</li>
</ol>
<ul>
<li><code>tigera-operator/tigera-operator-xxxx-xxx</code> </li>
</ul>
<p>监听 Installation CR，并按照配置安装 calico CNI。</p>
<ul>
<li>calico-system/calico-node</li>
</ul>
<p>DaemonSet，网络策略实现；设置Node节点上的路由；为 IPIP、VXLAN、WireGuard 管理虚拟接口。</p>
<ul>
<li>calico-system/calico-typha</li>
</ul>
<p>StatefulSet，作为 calico-node 用来查询、监听 api-server 时的缓存层，避免直接访问 api-server。它由 tigera-operator 来随着 node 的变化，进行扩缩容。</p>
<ul>
<li>calico-system/calico-controller</li>
</ul>
<p>calico 的各种 controller 集合，用于自动同步资源状态。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-12T06:54:14.638Z" title="2023-06-12T06:54:14.638Z">2023-06-12</time>发表</span><span class="level-item"><time dateTime="2023-06-12T06:54:14.638Z" title="2023-06-12T06:54:14.638Z">2023-06-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">2 分钟读完 (大约272个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/12/6352c36d7c20.html">Service 中的几个 port 的区别</a></h1><div class="content"><p><strong>Service</strong>: This directs the traffic to a pod.<br><strong>TargetPort</strong>: This is the actual port on which your application is running inside the container.<br><strong>Port</strong>: Some times your application inside container serves different services on a different port.</p>
<p>Example: The actual application can run 8080 and health checks for this application can run on 8089 port of the container. So if you hit the service without port it doesn’t know to which port of the container it should redirect the request. Service needs to have a mapping so that it can hit the specific port of the container.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30475</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8089</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31261</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5555</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5555</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">health</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30013</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8085</span></span><br></pre></td></tr></table></figure>

<p>if you hit the my-service:8089 the traffic is routed to 8080 of the container(targetPort). Similarly, if you hit my-service:8443 then it is redirected to 8085 of the container(targetPort). But this myservice:8089 is internal to the kubernetes cluster and can be used when one application wants to communicate with another application. So to hit the service from outside the cluster someone needs to expose the port on the host machine on which kubernetes is running so that the traffic is redirected to a port of the container. This is node port(port exposed on the host machine). From the above example, you can hit the service from outside the cluster(Postman or any rest-client) by host_ip:nodePort</p>
<p>Say your host machine ip is 10.10.20.20 you can hit the http, metrics, health services by 10.10.20.20:30475, 10.10.20.20:31261, 10.10.20.20:30013.</p>
<p>Edits: Edited as per Raedwald comment.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-12T06:51:46.309Z" title="2023-06-12T06:51:46.309Z">2023-06-12</time>发表</span><span class="level-item"><time dateTime="2023-06-12T06:51:46.309Z" title="2023-06-12T06:51:46.309Z">2023-06-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Docker/">Docker</a></span><span class="level-item">2 分钟读完 (大约228个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/12/38afcaa3bc3c.html">记录一个与容器1号进程有关的问题</a></h1><div class="content"><p>浏览器访问服务 502 发现服务挂了 但是 docker 状态看起来还正常着服务跑在 Docker 容器里面<br>启动方式为：<code>shell (pid -&gt; 1) -&gt; java ( pid != 1) </code></p>
<ol>
<li><code>docker ps</code> 能看见xxx的 STATUS 为 Up 4 days </li>
<li><code>docker top xxx</code> 显示出来无进程 </li>
<li><code>docker exec -it xxx bash</code> 显示 cannot exec in a stopped state: unknown </li>
</ol>
<p><img src="/images/pics/bf9Tka.jpg"></p>
<p>docker logs 能看见日志 可以看见最后一行日志为 killed<br>docker stop 需要等待一段时间才能结束 </p>
<p>Docker 版本：Docker Engine - Community 20.10.1 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ubuntu @ ucloud-hk in ~ [10:55:49]</span></span><br><span class="line">$ docker version</span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line">Version:           20.10.1</span><br><span class="line">API version:       1.41</span><br><span class="line">Go version:        go1.13.15</span><br><span class="line">Git commit:        831ebea</span><br><span class="line">Built:             Tue Dec 15 04:34:58 2020</span><br><span class="line">OS/Arch:           linux/amd64</span><br><span class="line">Context:           default</span><br><span class="line">Experimental:      <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line">Engine:</span><br><span class="line">Version:          20.10.1</span><br><span class="line">API version:      1.41 (minimum version 1.12)</span><br><span class="line">Go version:       go1.13.15</span><br><span class="line">Git commit:       f001486</span><br><span class="line">Built:            Tue Dec 15 04:32:52 2020</span><br><span class="line">OS/Arch:          linux/amd64</span><br><span class="line">Experimental:     <span class="literal">false</span></span><br><span class="line">containerd:</span><br><span class="line">Version:          1.4.3</span><br><span class="line">GitCommit:        269548fa27e0089a8b8278fc4fc781d7f65a939b</span><br><span class="line">runc:</span><br><span class="line">Version:          1.0.0-rc92</span><br><span class="line">GitCommit:        ff819c7e9184c13b7c2607fe6c30ae19403a7aff</span><br><span class="line">docker-init:</span><br><span class="line">Version:          0.19.0</span><br><span class="line">GitCommit:        de40ad0</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangjikuan/article/details/114702299">https://blog.csdn.net/zhangjikuan/article/details/114702299</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-12T06:45:41.482Z" title="2023-06-12T06:45:41.482Z">2023-06-12</time>发表</span><span class="level-item"><time dateTime="2023-06-12T06:45:41.482Z" title="2023-06-12T06:45:41.482Z">2023-06-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">5 分钟读完 (大约765个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/12/51cba5e1e272.html">手动安装K8s记录</a></h1><div class="content"><h2 id="必要的工具安装"><a href="#必要的工具安装" class="headerlink" title="必要的工具安装"></a>必要的工具安装</h2><ul>
<li><p>cfssl</p>
</li>
<li><p>cfssljson</p>
</li>
<li><p>kubectl</p>
<h2 id="证书与CA"><a href="#证书与CA" class="headerlink" title="证书与CA"></a>证书与CA</h2><p><img src="/images/pics/gOW9YM.jpeg"></p>
<h2 id="配置和生成kubeconfig"><a href="#配置和生成kubeconfig" class="headerlink" title="配置和生成kubeconfig"></a>配置和生成kubeconfig</h2></li>
<li><p>kubelet 配置文件</p>
</li>
</ul>
<p>worker-n.kubeconfig，分发到所有 <strong>worker</strong> 节点上。</p>
<ul>
<li>kube-proxy 配置文件</li>
</ul>
<p>kube-proxy.kubeconfig，分发到所有 <strong>worker</strong> 节点上。</p>
<ul>
<li>kube-controller-manager 配置文件</li>
</ul>
<p>kube-controller-manager.kubeconfig，分发到所有 <strong>控制节点</strong> 上。</p>
<ul>
<li>kube-scheduler 配置文件</li>
</ul>
<p>kube-scheduler.kubeconfig，分发到所有 <strong>控制节点</strong> 上。</p>
<ul>
<li>Admin 配置文件</li>
</ul>
<p>admin.kubeconfig，分发到所有 <strong>控制节点</strong> 上。</p>
<h2 id="配置加密k8s-secrets的秘钥"><a href="#配置加密k8s-secrets的秘钥" class="headerlink" title="配置加密k8s secrets的秘钥"></a>配置加密k8s secrets的秘钥</h2><p>encryption-config.yaml，分发到所有 <strong>控制节点</strong> 上。</p>
<h2 id="配置-amp-部署etcd"><a href="#配置-amp-部署etcd" class="headerlink" title="配置&amp;部署etcd"></a>配置&amp;部署etcd</h2><p>前置要求：etcd &amp; etcdctl 二进制<br>将 <code>ca.pem</code>、<code>kubernetes-key.pem</code>、<code>kubernetes.pem</code> 拷贝到 etcd 所在节点上，其中 <code>kubernetes-key.pem</code>、<code>kubernetes.pem</code> 作为 etcd https 服务的 TLS 证书。</p>
<h2 id="配置-amp-部署控制节点服务"><a href="#配置-amp-部署控制节点服务" class="headerlink" title="配置&amp;部署控制节点服务"></a>配置&amp;部署控制节点服务</h2><p>前置要求：kube-apiserver &amp; kube-controller-manager &amp; kube-scheduler &amp; kubectl 二进制</p>
<h3 id="api-server"><a href="#api-server" class="headerlink" title="api-server"></a>api-server</h3><p>在其启动参数中，需要</p>
<ol>
<li><p>指定 CA 为 <code>ca.pem</code></p>
</li>
<li><p>指定 etcd 的 CA 证书 <code>ca.pem</code>，公私钥为 <code>kubernetes-key.pem</code>、<code>kubernetes.pem</code>、及 etcd 的访问地址</p>
</li>
<li><p>指定 k8s secrets 的秘钥为 <code>encryption-config.yaml</code></p>
</li>
<li><p>指定 kubelet 的 CA 证书 <code>ca.pem</code>，公私钥为 <code>kubernetes-key.pem</code>、<code>kubernetes.pem</code></p>
</li>
<li><p>指定 api-server https 服务所用的 TLS 证书为 <code>kubernetes-key.pem</code>、<code>kubernetes.pem</code></p>
</li>
<li><p>指定 service account 的证书为 <code>service-account.pem</code></p>
<h3 id="controller-manager"><a href="#controller-manager" class="headerlink" title="controller-manager"></a>controller-manager</h3><p>在其启动参数中，需要</p>
</li>
<li><p>指定 cluster 所使用的 CA 的公私钥为 <code>ca.pem</code>、<code>ca-key.pem</code></p>
</li>
<li><p>指定 kubeconfig 使用 kube-controller-manager.kubeconfig</p>
</li>
<li><p>指定 root CA 为 <code>ca.pem</code></p>
</li>
<li><p>指定 service account 的私钥为 <code>service-account-key.pem</code></p>
<h3 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h3><p>在启动参数中，指定配置文件 <code>kube-scheduler.yaml</code>，然后在 <code>kube-scheduler.yaml</code> 中指定 kubeconfig 为 <code>kube-scheduler.kubeconfig</code>。</p>
</li>
</ol>
<hr>
<p>启动控制面服务 &amp; 验证</p>
<h2 id="给-kubelet-添加数据处理权限"><a href="#给-kubelet-添加数据处理权限" class="headerlink" title="给 kubelet 添加数据处理权限"></a>给 kubelet 添加数据处理权限</h2><p>创建 <code>system:kube-apiserver-to-kubelet</code> <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/admin/authorization/rbac/#role-and-clusterrole">ClusterRole</a> 及 <code>system:kube-apiserver</code> ClusterRoleBinding 以允许请求 Kubelet API 和执行大部分来管理 Pods 的任务</p>
<h2 id="配置-amp-部署worker节点"><a href="#配置-amp-部署worker节点" class="headerlink" title="配置&amp;部署worker节点"></a>配置&amp;部署worker节点</h2><ol>
<li><p>安装 OS 依赖的组件：socat conntrack ipset</p>
</li>
<li><p>安装 CRI</p>
</li>
<li><p>安装 worker 节点所需的二进制：<code>kubectl</code>、<code>kube-proxy</code>、<code>kubelet</code>、<code>默认提供的 CNI plugins</code></p>
<h3 id="配置kubelet"><a href="#配置kubelet" class="headerlink" title="配置kubelet"></a>配置kubelet</h3><p>创建 <code>kubelet-config.yaml</code> 文件，在该文件中指定</p>
</li>
<li><p>CA 证书</p>
</li>
<li><p>TLS 公私钥分别使用 <code>worker-1.pem</code>、<code>worker-1-key.pem</code>。好家伙，kubelet 又是一个 https 服务。</p>
</li>
</ol>
<p>并在 <code>kubelet.service</code> 指定</p>
<ol>
<li>配置文件使用文件</li>
<li>指定 kubelet 所使用的 kubeconfig 为 worker-n.kubeconfig<h3 id="配置kube-proxy"><a href="#配置kube-proxy" class="headerlink" title="配置kube-proxy"></a>配置kube-proxy</h3>创建 <code>kube-proxy-config.yaml</code> 文件，在该文件中指定所用的 kubeconfig 为 <code>kube-proxy.kubeconfig</code>；再在 <code>kubelet.service</code> 指定使用此配置文件。</li>
</ol>
<hr>
<p>启动控制面服务</p>
<h2 id="配置-kubectl-所使用的-kubeconfig"><a href="#配置-kubectl-所使用的-kubeconfig" class="headerlink" title="配置 kubectl 所使用的 kubeconfig"></a>配置 kubectl 所使用的 kubeconfig</h2><p>使用 admin.pem 和 admin-key.pem 生成 kubeconfig。</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get componentstatuses</span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>
<h2 id="安装其他重要的组件"><a href="#安装其他重要的组件" class="headerlink" title="安装其他重要的组件"></a>安装其他重要的组件</h2><ol>
<li><p>安装 CNI</p>
</li>
<li><p>DNS</p>
</li>
<li><p>验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl run busybox --image=busybox:1.28.3 --<span class="built_in">command</span> -- sleep 3600</span><br><span class="line">kubectl get pods -l run=busybox</span><br><span class="line">kubectl <span class="built_in">exec</span> -ti <span class="variable">$POD_NAME</span> -- nslookup kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="烟雾测试"><a href="#烟雾测试" class="headerlink" title="烟雾测试"></a>烟雾测试</h2></li>
<li><p>数据加密</p>
</li>
<li><p>Deployment</p>
<ol>
<li>创建</li>
<li>端口转发</li>
<li>容器日志</li>
<li>在容器中执行命令</li>
</ol>
</li>
<li><p>Service</p>
<ol>
<li>创建</li>
<li>访问</li>
</ol>
</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-12T06:41:33.669Z" title="2023-06-12T06:41:33.669Z">2023-06-12</time>发表</span><span class="level-item"><time dateTime="2023-06-12T06:41:33.669Z" title="2023-06-12T06:41:33.669Z">2023-06-12</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">5 分钟读完 (大约804个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/12/e1999bb16b6a.html">PV、PVC、StorageClass 概览</a></h1><div class="content"><h2 id="为何如此设计"><a href="#为何如此设计" class="headerlink" title="为何如此设计"></a>为何如此设计</h2><ol>
<li><p>解耦对存储的使用与维护</p>
</li>
<li><p>拓展不同的存储需求</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>PV 描述的是持久化存储数据卷。这个 API 对象主要定义的是⼀个持久化存储在宿主机上的⽬录，⽐如⼀个 NFS 的挂载⽬录。通常情况下，PV 对象是由运维⼈员事先创建在 Kubernetes 集群⾥待⽤的。_<strong>类似于接口的具体实现，干活的打工人</strong><em>。<br>PVC 描述的是 Pod 所希望使⽤的持久化存储的属性。PVC 对象通常由开发⼈员创建；或者以 PVC 模板的⽅式成为 StatefulSet 的⼀部分，然后由 StatefulSet 控制器负责创建带编号的 PVC。</em><strong>类似于接口，不提供具体实现</strong>_。</p>
<h2 id="PV与PVC匹配绑定"><a href="#PV与PVC匹配绑定" class="headerlink" title="PV与PVC匹配绑定"></a>PV与PVC匹配绑定</h2><h3 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h3></li>
<li><p>两者的 spec 字段匹配</p>
</li>
<li><p>两者的 storageClassName 字段必须相同</p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>通过<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/persistentvolume/pv_controller.go"> operator 机制</a>，为每个未处于 Bound 状态的 PVC，遍历所有可用的 PV，来匹配到合适的 PV。</p>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>在 PVC 的 spec.volumeName 字段上填写上 PV 的名称</p>
<h2 id="两阶段处理"><a href="#两阶段处理" class="headerlink" title="两阶段处理"></a>两阶段处理</h2></li>
<li><p>Attach 调用存储系统的 API 将存储挂载到 Pod 将要调度到的 Node 上；</p>
</li>
</ol>
<p>由 AttachDetachController 管理。它不断地检查每⼀个 Pod 对应的 PV，和 这个 Pod 所在宿主机之间挂载情况。从⽽决定，是否需要对这个 PV 进⾏ Attach（或者 Dettach）操作。<br>作为⼀个 Kubernetes 内置的控制器，Volume Controller ⾃然是 kube-controller-manager 的⼀部分。所以，AttachDetachController 也⼀定是<strong>运⾏在 Master 节点上</strong>的。当然，Attach 操作只需要调⽤公有云或者具体存储项⽬的 API，并不需要在具体的宿主机上执⾏操作。</p>
<ol start="2">
<li>Mount<ol>
<li>格式化存储设备</li>
<li>绑定挂载到 Pod 中</li>
</ol>
</li>
</ol>
<p>由 VolumeManagerReconciler 管理。它必须发⽣在 Pod 对应的宿主机上，所以必须是 kubelet 组件的⼀部分。它运⾏起来之后，是⼀个独⽴于 kubelet 主循环的 Goroutine（不堵塞 kubelet 主控循环）。</p>
<h2 id="PV-管理方式"><a href="#PV-管理方式" class="headerlink" title="PV 管理方式"></a>PV 管理方式</h2><ul>
<li>Static Provisioning</li>
</ul>
<p>创建 PVC 之后，由运维人员手动创建 PV 的方式</p>
<ul>
<li>Dynamic Provisioning</li>
</ul>
<p>创建 PVC 时指定 StorageClass，由 StorageClass 中指定的 provisioner 来创建对应的 PV。</p>
<h2 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h2><p>当 PVC 中指定的 StorageClass 存在时，调用对应的 provisioner 来创建 PV；否则去匹配带有相同 StorageClass 的 PV。<br>如果 PVC 中未指定 StorageClass，当集群已经开启了名叫 DefaultStorageClass 的 Admission Plugin时，它就会为 PVC 和 PV ⾃动添加⼀个默认的 StorageClass；否则，PVC 的 storageClassName 的值就是“”，这也意味着它只能够跟 storageClassName 也是“”的 PV 进⾏绑定。</p>
<h2 id="本地持久化卷的实现"><a href="#本地持久化卷的实现" class="headerlink" title="本地持久化卷的实现"></a>本地持久化卷的实现</h2><p>延迟绑定：当使用本地存储后，需要延迟 PV 与 PVC 之间的绑定时机到 Pod 调度时，避免出现 PV 与 Pod 不在同一节点上面的问题。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/no-provisioner</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br></pre></td></tr></table></figure>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/26/">26</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-21T02:20:08.000Z">2024-02-21</time></p><p class="title"><a href="/2024/02/21/84ee50d29e8e.html">Google Pixel 7a玩机攻略</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-30T06:39:01.000Z">2024-01-30</time></p><p class="title"><a href="/2024/01/30/64634917304d.html">2024年CKS考试准备</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2023/06/26/dee71ca0ecee.html"><img src="/images/pics/wkhGYG.jpg" alt="利用OpenWrt为虚拟机做流量代理"></a></figure><div class="media-content"><p class="date"><time dateTime="2023-06-26T02:55:51.382Z">2023-06-26</time></p><p class="title"><a href="/2023/06/26/dee71ca0ecee.html">利用OpenWrt为虚拟机做流量代理</a></p><p class="categories"><a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2023/06/12/916fff7d458d.html"><img src="/images/pics/b00a1e01142bcaeee115eaab5848ce85.jpg" alt="Git 操作及原理"></a></figure><div class="media-content"><p class="date"><time dateTime="2023-06-12T07:12:22.446Z">2023-06-12</time></p><p class="title"><a href="/2023/06/12/916fff7d458d.html">Git 操作及原理</a></p><p class="categories"><a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2023/06/12/e54d04dcd0b8.html"><img src="/images/pics/Sd0C2u.jpg" alt="换行符问题"></a></figure><div class="media-content"><p class="date"><time dateTime="2023-06-12T07:08:08.170Z">2023-06-12</time></p><p class="title"><a href="/2023/06/12/e54d04dcd0b8.html">换行符问题</a></p><p class="categories"><a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="一条肥鱼" height="28"></a><p class="is-size-7"><span>&copy; 2024 一条肥鱼</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/feiyudev"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>